<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closetly - Your Personal Style AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Authentication Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 440px;
            width: 100%;
            padding: 48px 40px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-logo p {
            color: #666;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            color: #666;
        }

        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        /* Main App (Hidden until logged in) */
        .main-app {
            display: none;
        }

        /* Keep all other styles from original... */
        /* Copy remaining CSS from original file here */
        
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="auth-container">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>‚ú® Closetly</h1>
                <p>Your Personal Style AI</p>
            </div>

            <div id="loginError" class="error-message"></div>

            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" required placeholder="you@example.com">
                </div>

                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" required placeholder="Enter your password">
                </div>

                <button type="submit" class="auth-btn" id="loginBtn">Log In</button>
            </form>

            <div class="auth-switch">
                Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Signup Page -->
    <div id="signupPage" class="auth-container" style="display: none;">
        <div class="auth-card">
            <div class="auth-logo">
                <h1>‚ú® Closetly</h1>
                <p>Create Your Account</p>
            </div>

            <div id="signupError" class="error-message"></div>
            <div id="signupSuccess" class="success-message"></div>

            <form id="signupForm">
                <div class="form-group">
                    <label for="signupName">Full Name</label>
                    <input type="text" id="signupName" required placeholder="Your name">
                </div>

                <div class="form-group">
                    <label for="signupEmail">Email Address</label>
                    <input type="email" id="signupEmail" required placeholder="you@example.com">
                </div>

                <div class="form-group">
                    <label for="signupPassword">Password</label>
                    <input type="password" id="signupPassword" required placeholder="At least 6 characters" minlength="6">
                </div>

                <div class="form-group">
                    <label for="signupPasswordConfirm">Confirm Password</label>
                    <input type="password" id="signupPasswordConfirm" required placeholder="Confirm your password">
                </div>

                <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
            </form>

            <div class="auth-switch">
                Already have an account? <a href="#" onclick="showLogin(); return false;">Log In</a>
            </div>
        </div>
    </div>

    <!-- Main App (Copy all content from original HTML) -->
    <div id="mainApp" class="main-app">
       <div class="container">
        <div class="header">
            <h1>Closetly</h1>
            <p class="tagline">Personalised Fashion At Your FingerTips</p>
            <p class="subtitle">AI-powered style recommendations for everyone</p>
        </div>

        <div class="step-indicator">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
            <div class="step-dot" id="dot3"></div>
            <div class="step-dot" id="dot4"></div>
        </div>

        <div class="progress-bar">
            <div class="progress" id="progressBar" style="width: 25%"></div>
        </div>

        <!-- Step 0: Gender Selection -->
        <div class="step active" id="step0">
            <div class="quiz-section">
                <h2>Tell Us About Yourself</h2>
                <p>Choose your style preference to get personalized recommendations:</p>
                
                <div class="gender-selection">
                    <div class="gender-option" data-gender="women">
                        <span class="gender-icon">üë©</span>
                        <div><strong>Women's Style</strong></div>
                        <small>Dresses, blazers, and contemporary fashion</small>
                    </div>
                    <div class="gender-option" data-gender="men">
                        <span class="gender-icon">üë®</span>
                        <div><strong>Men's Style</strong></div>
                        <small>Suits, casual wear, and modern essentials</small>
                    </div>
                    <div class="gender-option" data-gender="unisex">
                        <span class="gender-icon">‚ú®</span>
                        <div><strong>Non-Binary/Fluid</strong></div>
                        <small>All styles, no limits</small>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn" onclick="nextStep()" id="genderNextBtn" disabled>Next: Body Assessment</button>
                </div>
            </div>
        </div>

        <!-- Step 1: Body Type Quiz -->
        <div class="step" id="step1">
            <div class="quiz-section">
                <h2>Step 1: Body Type Assessment</h2>
                <p>Choose your preferred method for the most accurate recommendations:</p>
                
                <div class="assessment-method">
                    <div class="method-toggle">
                        <button class="method-btn active" onclick="switchMethod('visual')" id="visualBtn">Visual Assessment</button>
                        <button class="method-btn" onclick="switchMethod('measurements')" id="measurementsBtn">Enter Measurements</button>
                    </div>
                </div>

                <!-- Visual Assessment -->
                <div id="visualAssessment" class="assessment-content">
                    <div class="question">
                        <h3>1. How would you describe your shoulder width compared to your hips?</h3>
                        <div class="options">
                            <div class="option" data-question="q1" data-value="wider">Shoulders wider than hips</div>
                            <div class="option" data-question="q1" data-value="equal">Shoulders equal to hips</div>
                            <div class="option" data-question="q1" data-value="narrower">Shoulders narrower than hips</div>
                        </div>
                    </div>

                    <div class="question">
                        <h3>2. Where do you tend to gain weight first?</h3>
                        <div class="options">
                            <div class="option" data-question="q2" data-value="upper">Upper body (arms, chest, shoulders)</div>
                            <div class="option" data-question="q2" data-value="middle">Middle section (waist, stomach)</div>
                            <div class="option" data-question="q2" data-value="lower">Lower body (hips, thighs, legs)</div>
                            <div class="option" data-question="q2" data-value="overall">Evenly throughout</div>
                        </div>
                    </div>

                    <div class="question">
                        <h3>3. How would you describe your torso shape?</h3>
                        <div class="options">
                            <div class="option" data-question="q3" data-value="defined">Well-defined waist, curvy silhouette</div>
                            <div class="option" data-question="q3" data-value="straight">Straight, athletic build</div>
                            <div class="option" data-question="q3" data-value="fuller">Fuller midsection, rounded silhouette</div>
                        </div>
                    </div>

                    <div class="question">
                        <h3>4. What's your chest/bust measurement compared to your hips?</h3>
                        <div class="options">
                            <div class="option" data-question="q4" data-value="larger">Chest/bust larger than hips</div>
                            <div class="option" data-question="q4" data-value="same">About the same size</div>
                            <div class="option" data-question="q4" data-value="smaller">Chest/bust smaller than hips</div>
                        </div>
                    </div>
                </div>

                <!-- Measurements Assessment -->
                <div id="measurementsAssessment" class="assessment-content" style="display: none;">
                    <p style="color: #666; margin-bottom: 20px; text-align: center;">
                        Enter your measurements for the most accurate body type analysis
                    </p>
                    <div class="measurements-form">
                        <div class="measurement-input">
                            <label>Shoulder Width (inches)</label>
                            <input type="number" id="shoulderInput" placeholder="e.g., 15-18" step="0.5" min="10" max="30">
                        </div>
                        <div class="measurement-input">
                            <label id="chestLabel">Bust (inches)</label>
                            <input type="number" id="chestInput" placeholder="e.g., 32-40" step="0.5" min="20" max="60">
                        </div>
                        <div class="measurement-input">
                            <label>Waist (inches)</label>
                            <input type="number" id="waistInput" placeholder="e.g., 24-36" step="0.5" min="20" max="60">
                        </div>
                        <div class="measurement-input">
                            <label>Hip (inches)</label>
                            <input type="number" id="hipInput" placeholder="e.g., 34-44" step="0.5" min="20" max="60">
                        </div>
                        <div class="measurement-input">
                            <label>Height (inches)</label>
                            <input type="number" id="heightInput" placeholder="e.g., 60-72" step="0.5" min="48" max="84">
                        </div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="previousStep()">‚Üê Back</button>
                    <button class="btn" onclick="calculateBodyType()" id="nextBtn1" disabled>Next: Color Analysis</button>
                </div>
            </div>
        </div>

        <!-- Step 2: Color Analysis -->
        <div class="step" id="step2">
            <div class="quiz-section">
                <h2>Step 2: Personal Color Analysis</h2>
                <p>Upload a clear photo of your face in natural lighting for personalized color analysis:</p>
                
                <div class="upload-area" id="uploadArea">
                    <div id="uploadContent">
                        <p>üì∑ Click to upload or drag and drop your photo</p>
                        <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Supported formats: JPG, PNG</p>
                        <small style="color: #888;">We analyze skin tone, undertones, and natural features for optimal recommendations</small>
                    </div>
                    <img id="imagePreview" style="display: none;">
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>

                <div id="colorAnalysisLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Analyzing your personal colors...</p>
                    <small>Processing skin tone, undertones, and natural features...</small>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="previousStep()">‚Üê Back</button>
                    <button class="btn" onclick="analyzeColors()" id="nextBtn2" disabled>Get My Style Profile</button>
                </div>
            </div>
        </div>

        <!-- Step 3: Results & Shopping -->
        <div class="step" id="step3">
            <div class="results">
                <h2>Your Closetly Style Profile</h2>
                <p>Based on your assessment, here are your personalized fashion recommendations:</p>
                
                <div class="result-card" id="bodyTypeResult">
                    <h3>Your Body Type: <span id="bodyTypeName"></span></h3>
                    <p id="bodyTypeDescription"></p>
                </div>

                <div class="result-card" id="colorAnalysisResult">
                    <h3>Your Personal Color Palette</h3>
                    <div class="color-palette" id="colorPalette"></div>
                    <p id="colorDescription"></p>
                </div>

                <div class="tabs">
                    <button class="tab active" onclick="showTab('recommendations', this)">Style Guide</button>
                    <button class="tab" onclick="showTab('shopping', this)">Shop Now</button>
                    <button class="tab" onclick="showTab('comparison', this)">Price Compare</button>
                </div>

                <div class="tab-content active" id="recommendations">
                    <div class="recommendation-grid" id="styleRecommendations"></div>
                </div>

                <div class="tab-content" id="shopping">
                    <div class="product-grid" id="productGrid"></div>
                </div>

                <div class="tab-content" id="comparison">
                    <div class="price-comparison" id="priceComparison">
                        <h3>Price Comparison Across Brands</h3>
                        <p>Compare prices for similar items across different retailers and brands:</p>
                        <div class="comparison-filters">
                            <select id="categoryFilter" onchange="filterComparisons()">
                                <option value="all">All Categories</option>
                                <option value="blazers">Blazers & Jackets</option>
                                <option value="shirts">Shirts & Tops</option>
                                <option value="pants">Pants & Jeans</option>
                                <option value="dresses">Dresses & Skirts</option>
                            </select>
                            <select id="priceRangeFilter" onchange="filterComparisons()">
                                <option value="all">All Prices</option>
                                <option value="budget">Under ‚Çπ2000</option>
                                <option value="mid">‚Çπ2000-‚Çπ5000</option>
                                <option value="premium">Above ‚Çπ5000</option>
                            </select>
                        </div>
                        <div id="comparisonResults"></div>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 30px;">
                    <button class="btn" onclick="previousStep()">‚Üê Back</button>
                    <button class="btn" onclick="resetQuiz()">New Assessment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Chatbot Widget -->
    <div class="chat-widget">
        <button class="chat-toggle-btn" id="chatToggle" onclick="toggleChatbot()">
            <span class="chat-icon">ü§ñ</span>
            <span class="chat-notification" id="chatNotification">1</span>
        </button>

        <div class="chat-container" id="chatbotContainer">
            <div class="chat-header">
                <div class="chat-avatar">üëó</div>
                <div class="chat-header-info">
                    <h3>Style Advisor</h3>
                    <p>AI-powered outfit expert</p>
                </div>
            </div>

            <div class="chat-messages" id="chatbotMessages"></div>

            <div class="chat-input-container">
                <input type="text" class="chat-input" id="chatbotInput" placeholder="Ask about your outfit..." onkeypress="handleChatKeyPress(event)">
                <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
            </div>
        </div>
    </div>

    <script>
        let currentStep = 0;
        let selectedGender = '';
        let quizAnswers = {};
        let bodyType = '';
        let dominantColors = [];
        let uploadedImage = null;
        let userProfile = {};
        let assessmentMethod = 'visual';
        let measurements = {};
        let chatbotOpen = false;
        let chatbotHistory = [];
        let uploadedOutfitImage = null;

        // Retailer URL mapping for redirects
        const retailerURLs = {
            'Myntra': 'https://www.myntra.com/shop/',
            'Ajio': 'https://www.ajio.com/search/?text=',
            'Flipkart': 'https://www.flipkart.com/search?q=',
            'Amazon India': 'https://www.amazon.in/s?k=',
            'Lifestyle': 'https://www.lifestylestores.com/in/en/search/?text=',
            'Westside': 'https://www.westside.com/search?q=',
            'Shoppers Stop': 'https://www.shoppersstop.com/search?q=',
            'Reliance Trends': 'https://www.reliancetrends.com/search?q=',
            'Max Fashion': 'https://www.maxfashion.in/in/en/search/?text='
        };

        // Product image placeholders (you can replace these with actual image URLs)
        const productImages = {
            'Wrap Midi Dress': 'https://images.unsplash.com/photo-1595777457583-95e059d581b8?w=400',
            'High-Waisted Jeans': 'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=400',
            'Fitted Blazer': 'https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=400',
            'Silk Blouse': 'https://images.unsplash.com/photo-1564584217132-2271feaeb3c5?w=400',
            'Pencil Skirt': 'https://images.unsplash.com/photo-1583496661160-fb5886a0aaaa?w=400',
            'Bodycon Dress': 'https://images.unsplash.com/photo-1566174053879-31528523f8ae?w=400',
            'Oxford Shirt': 'https://images.unsplash.com/photo-1602810318383-e386cc2a3ccf?w=400',
            'Slim Fit Chinos': 'https://images.unsplash.com/photo-1473966968600-fa801b869a1a?w=400',
            'Formal Suit': 'https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=400',
            'Polo Shirt': 'https://images.unsplash.com/photo-1586790170083-2f9ceadc732d?w=400',
            'Leather Jacket': 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=400',
            'Denim Jeans': 'https://images.unsplash.com/photo-1542272604-787c3835535d?w=400',
            'Oversized Hoodie': 'https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=400',
            'Denim Jacket': 'https://images.unsplash.com/photo-1576995853123-5a10305d93c0?w=400',
            'Basic White Tee': 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400',
            'Joggers': 'https://images.unsplash.com/photo-1517438322307-e67111335449?w=400'
        };

        const bodyTypeRecommendations = {
            women: {
                'Hourglass': {
                    description: 'You have a balanced, proportionate silhouette with a defined waist.',
                    recommendations: [
                        'Wrap dresses that cinch at the waist',
                        'High-waisted jeans and trousers',
                        'Fitted blazers and structured jackets',
                        'Bodycon dresses and pencil skirts',
                        'Belted coats and dresses',
                        'V-neck and scoop neck tops'
                    ]
                },
                'Pear': {
                    description: 'You have narrower shoulders and bust with fuller hips and thighs.',
                    recommendations: [
                        'Boat neck and off-shoulder tops',
                        'Statement sleeves and embellished tops',
                        'Dark-colored bootcut and flared jeans',
                        'A-line skirts and dresses',
                        'Structured blazers with shoulder details',
                        'Bright colored scarves and statement necklaces'
                    ]
                },
                'Apple': {
                    description: 'You carry weight in your midsection with broader shoulders.',
                    recommendations: [
                        'Empire waist dresses and tops',
                        'V-neck and deep scoop neck styles',
                        'Open cardigans and longline jackets',
                        'Straight-leg and bootcut jeans',
                        'Flowy tunics and A-line tops',
                        'Mid-rise trousers with structured tops'
                    ]
                },
                'Rectangle': {
                    description: 'You have a straight, athletic build with minimal waist definition.',
                    recommendations: [
                        'Peplum tops and ruffled blouses',
                        'Belted dresses and high-waisted bottoms',
                        'Layered outfits with jackets',
                        'Textured fabrics and bold prints',
                        'Cropped jackets and structured blazers',
                        'Fit-and-flare dresses'
                    ]
                },
                'Inverted Triangle': {
                    description: 'You have broader shoulders and bust with narrower hips.',
                    recommendations: [
                        'A-line and flared skirts',
                        'Wide-leg trousers and bootcut jeans',
                        'V-neck and scoop neck tops',
                        'Unstructured, flowy tops',
                        'Bright colored bottoms with dark tops',
                        'Wrap dresses with fuller skirts'
                    ]
                }
            },
            men: {
                'Athletic': {
                    description: 'You have broad shoulders, a narrow waist, and a muscular build.',
                    recommendations: [
                        'Fitted dress shirts and polo shirts',
                        'Slim-fit blazers and sport coats',
                        'Tapered trousers and slim-fit jeans',
                        'V-neck sweaters and henley shirts',
                        'Structured suits with defined shoulders',
                        'Form-fitting casual tees'
                    ]
                },
                'Rectangle': {
                    description: 'You have a straight build with similar measurements.',
                    recommendations: [
                        'Layered looks with jackets and vests',
                        'Textured fabrics and patterns',
                        'Double-breasted blazers',
                        'Chunky knit sweaters',
                        'Horizontal striped shirts',
                        'Slim-fit pants to create shape'
                    ]
                },
                'Inverted Triangle': {
                    description: 'You have broad shoulders and chest with a narrower waist.',
                    recommendations: [
                        'Straight-leg and relaxed-fit jeans',
                        'Unstructured blazers without padding',
                        'Crew neck sweaters and t-shirts',
                        'Simple, clean-line shirts',
                        'Solid colors and minimal patterns',
                        'Casual, unpadded jackets'
                    ]
                },
                'Trapezoid': {
                    description: 'You have narrower shoulders with broader hips and thighs.',
                    recommendations: [
                        'Structured blazers with shoulder pads',
                        'Fitted shirts with broader collars',
                        'Vertical striped patterns',
                        'Tailored jackets with defined shoulders',
                        'V-neck sweaters',
                        'Straight-cut formal trousers'
                    ]
                },
                'Oval': {
                    description: 'You carry weight in your midsection with a fuller torso.',
                    recommendations: [
                        'V-neck shirts and sweaters',
                        'Open blazers and cardigans',
                        'Vertical stripe patterns',
                        'Longer length shirts',
                        'Straight-leg trousers',
                        'Dark colors for upper body'
                    ]
                }
            },
            unisex: {
                'Balanced': {
                    description: 'You have a well-proportioned silhouette.',
                    recommendations: [
                        'Oversized blazers and structured jackets',
                        'High-waisted bottoms with tucked shirts',
                        'Tailored pants and jeans',
                        'Gender-neutral cuts',
                        'Layered looks',
                        'Statement accessories'
                    ]
                },
                'Linear': {
                    description: 'You have a straight, elongated silhouette.',
                    recommendations: [
                        'Structured pieces with geometric lines',
                        'Tailored fits throughout',
                        'Monochromatic color schemes',
                        'Minimal jewelry',
                        'Sharp silhouettes',
                        'Contemporary minimalist pieces'
                    ]
                }
            }
        };

        const sampleProducts = {
            women: [
                { name: 'Wrap Midi Dress', brand: 'AND', price: 1999, originalPrice: 2999, rating: 4.5, category: 'dresses' },
                { name: 'High-Waisted Jeans', brand: 'Levi\'s', price: 2499, originalPrice: 3499, rating: 4.6, category: 'jeans' },
                { name: 'Fitted Blazer', brand: 'Marks & Spencer', price: 2999, originalPrice: 4499, rating: 4.7, category: 'blazers' },
                { name: 'Silk Blouse', brand: 'Van Heusen Woman', price: 1499, originalPrice: 2199, rating: 4.4, category: 'tops' },
                { name: 'Pencil Skirt', brand: 'Vero Moda', price: 1299, originalPrice: 1899, rating: 4.3, category: 'skirts' },
                { name: 'Bodycon Dress', brand: 'Forever New', price: 2799, originalPrice: 3999, rating: 4.6, category: 'dresses' }
            ],
            men: [
                { name: 'Oxford Shirt', brand: 'Van Heusen', price: 1299, originalPrice: 1799, rating: 4.6, category: 'shirts' },
                { name: 'Slim Fit Chinos', brand: 'Allen Solly', price: 1599, originalPrice: 2299, rating: 4.5, category: 'pants' },
                { name: 'Formal Suit', brand: 'Raymond', price: 9999, originalPrice: 14999, rating: 4.8, category: 'suits' },
                { name: 'Polo Shirt', brand: 'US Polo Assn', price: 899, originalPrice: 1299, rating: 4.7, category: 'shirts' },
                { name: 'Leather Jacket', brand: 'Being Human', price: 4999, originalPrice: 6999, rating: 4.6, category: 'jackets' },
                { name: 'Denim Jeans', brand: 'Levi\'s 511', price: 2299, originalPrice: 3199, rating: 4.7, category: 'jeans' }
            ],
            unisex: [
                { name: 'Oversized Hoodie', brand: 'Nike', price: 1999, originalPrice: 2799, rating: 4.4, category: 'hoodies' },
                { name: 'Denim Jacket', brand: 'Levi\'s', price: 2999, originalPrice: 3999, rating: 4.6, category: 'jackets' },
                { name: 'Basic White Tee', brand: 'H&M', price: 499, originalPrice: 799, rating: 4.5, category: 'tshirts' },
                { name: 'Joggers', brand: 'Adidas', price: 1499, originalPrice: 2199, rating: 4.3, category: 'bottoms' }
            ]
        };

        const priceComparisonData = {
            'Blazer': [
                { retailer: 'Myntra', brand: 'Marks & Spencer', price: 2999, originalPrice: 4499, rating: 4.5, image: productImages['Fitted Blazer'] },
                { retailer: 'Ajio', brand: 'Van Heusen', price: 2699, originalPrice: 3999, rating: 4.3, image: productImages['Fitted Blazer'] },
                { retailer: 'Flipkart', brand: 'Peter England', price: 2499, originalPrice: 3499, rating: 4.6, image: productImages['Fitted Blazer'] },
                { retailer: 'Amazon India', brand: 'Allen Solly', price: 2799, originalPrice: 3799, rating: 4.4, image: productImages['Fitted Blazer'] }
            ],
            'Formal Shirt': [
                { retailer: 'Myntra', brand: 'Van Heusen', price: 1299, originalPrice: 1799, rating: 4.6, image: productImages['Oxford Shirt'] },
                { retailer: 'Lifestyle', brand: 'Louis Philippe', price: 1599, originalPrice: 2299, rating: 4.5, image: productImages['Oxford Shirt'] },
                { retailer: 'Amazon India', brand: 'Arrow', price: 1199, originalPrice: 1699, rating: 4.3, image: productImages['Oxford Shirt'] },
                { retailer: 'Flipkart', brand: 'Peter England', price: 999, originalPrice: 1499, rating: 4.4, image: productImages['Oxford Shirt'] }
            ],
            'Jeans': [
                { retailer: 'Myntra', brand: 'Levi\'s 511', price: 2299, originalPrice: 3199, rating: 4.7, image: productImages['Denim Jeans'] },
                { retailer: 'Ajio', brand: 'Flying Machine', price: 1599, originalPrice: 2299, rating: 4.4, image: productImages['Denim Jeans'] },
                { retailer: 'Amazon India', brand: 'Wrangler', price: 1799, originalPrice: 2499, rating: 4.3, image: productImages['Denim Jeans'] },
                { retailer: 'Lifestyle', brand: 'Lee', price: 2099, originalPrice: 2899, rating: 4.2, image: productImages['Denim Jeans'] }
            ],
            'Dress': [
                { retailer: 'Myntra', brand: 'AND', price: 1999, originalPrice: 2999, rating: 4.5, image: productImages['Wrap Midi Dress'] },
                { retailer: 'Ajio', brand: 'Vero Moda', price: 1799, originalPrice: 2599, rating: 4.4, image: productImages['Bodycon Dress'] },
                { retailer: 'Lifestyle', brand: 'Forever New', price: 2499, originalPrice: 3499, rating: 4.6, image: productImages['Wrap Midi Dress'] },
                { retailer: 'Amazon India', brand: 'Athena', price: 1399, originalPrice: 1999, rating: 4.3, image: productImages['Bodycon Dress'] }
            ]
        };

        const outfitKnowledge = {
            bodyTypeAdvice: {
                'Hourglass': 'Your balanced silhouette looks stunning in fitted styles! Try wrap dresses, high-waisted jeans, and belted blazers.',
                'Pear': 'Balance your figure with statement tops and darker bottoms. Boat necks and A-line skirts are perfect!',
                'Apple': 'Empire waist dresses and V-necks elongate your torso beautifully. Flow is your friend!',
                'Rectangle': 'Add curves with peplum tops, belts, and textured fabrics. Layering works wonders!',
                'Inverted Triangle': 'Balance broad shoulders with A-line bottoms and wide-leg pants. Soft fabrics are key!',
                'Athletic': 'Your proportions work with most styles! Try fitted cuts and structured pieces.',
                'Trapezoid': 'Create shoulder emphasis with structured blazers and vertical stripes.',
                'Oval': 'V-necks and vertical patterns elongate beautifully. Dark tops with bright bottoms create balance!',
                'Balanced': 'You can wear almost anything! Experiment with different styles.',
                'Linear': 'Structured pieces and tailored fits complement your silhouette perfectly.'
            },
            colorAdvice: {
                'spring': 'Warm, bright colors like coral, peach, and golden yellow make you glow! ‚ú®',
                'summer': 'Cool, soft pastels like lavender, powder blue, and soft pink suit you best! üíú',
                'autumn': 'Rich earth tones like rust, olive, and camel enhance your warmth! üçÇ',
                'winter': 'Bold jewel tones, pure white, and black create stunning contrast! ‚ùÑÔ∏è'
            }
        };

        function getRetailerSearchURL(retailer, brand, productName) {
            const searchQuery = encodeURIComponent(`${brand} ${productName}`);
            const baseURL = retailerURLs[retailer] || 'https://www.google.com/search?q=';
            return baseURL + searchQuery;
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.gender-option').forEach(option => {
                option.addEventListener('click', function() {
                    document.querySelectorAll('.gender-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedGender = this.dataset.gender;
                    document.getElementById('genderNextBtn').disabled = false;
                });
            });

            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const question = this.dataset.question;
                    const value = this.dataset.value;
                    document.querySelectorAll(`[data-question="${question}"]`).forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    quizAnswers[question] = value;
                    checkQuizComplete();
                });
            });

            const uploadArea = document.getElementById('uploadArea');
            const imageInput = document.getElementById('imageInput');
            
            uploadArea.addEventListener('click', () => imageInput.click());
            imageInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        });

        function switchMethod(method) {
            assessmentMethod = method;
            document.getElementById('visualBtn').classList.toggle('active', method === 'visual');
            document.getElementById('measurementsBtn').classList.toggle('active', method === 'measurements');
            document.getElementById('visualAssessment').style.display = method === 'visual' ? 'block' : 'none';
            document.getElementById('measurementsAssessment').style.display = method === 'measurements' ? 'block' : 'none';
            
            if (method === 'measurements') {
                const chestLabel = document.getElementById('chestLabel');
                chestLabel.textContent = selectedGender === 'women' ? 'Bust (inches)' : 'Chest (inches)';
                setupMeasurementListeners();
            }
            checkQuizComplete();
        }

        function setupMeasurementListeners() {
            ['shoulderInput', 'chestInput', 'waistInput', 'hipInput', 'heightInput'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        measurements[id.replace('Input', '')] = parseFloat(input.value) || 0;
                        checkQuizComplete();
                    });
                }
            });
        }

        function checkQuizComplete() {
            const nextBtn1 = document.getElementById('nextBtn1');
            if (!nextBtn1) return;
            
            if (assessmentMethod === 'visual') {
                const answered = ['q1', 'q2', 'q3', 'q4'].every(q => quizAnswers[q]);
                nextBtn1.disabled = !answered;
            } else {
                const allFilled = ['shoulder', 'chest', 'waist', 'hip', 'height'].every(m => measurements[m] && measurements[m] > 0);
                nextBtn1.disabled = !allFilled;
            }
        }

        function calculateBodyType() {
            if (assessmentMethod === 'measurements') {
                bodyType = calculateBodyTypeFromMeasurements();
            } else {
                bodyType = calculateBodyTypeFromQuiz();
            }
            nextStep();
        }

        function calculateBodyTypeFromMeasurements() {
            const { shoulder, chest, waist, hip } = measurements;
            
            if (selectedGender === 'women') {
                const bustHipRatio = chest / hip;
                const waistBustRatio = waist / chest;
                
                if (bustHipRatio >= 0.95 && bustHipRatio <= 1.05 && waistBustRatio <= 0.75) return 'Hourglass';
                else if (bustHipRatio < 0.95) return 'Pear';
                else if (waistBustRatio >= 0.75) return 'Apple';
                else if (bustHipRatio > 1.05) return 'Inverted Triangle';
                else return 'Rectangle';
            } else if (selectedGender === 'men') {
                const shoulderWaistRatio = shoulder / waist;
                const chestWaistRatio = chest / waist;
                
                if (shoulderWaistRatio >= 1.40 && chestWaistRatio >= 1.25) return 'Athletic';
                else if (shoulderWaistRatio >= 1.30) return 'Inverted Triangle';
                else if (shoulder < hip) return 'Trapezoid';
                else if (chestWaistRatio <= 1.15) return 'Oval';
                else return 'Rectangle';
            } else {
                return waist / chest < 0.80 ? 'Balanced' : 'Linear';
            }
        }

        function calculateBodyTypeFromQuiz() {
            const { q1, q2, q3, q4 } = quizAnswers;
            
            if (selectedGender === 'men') {
                if (q1 === 'wider' && q3 === 'defined') return 'Athletic';
                else if (q1 === 'wider' && q4 === 'larger') return 'Inverted Triangle';
                else if (q1 === 'narrower' && q4 === 'smaller') return 'Trapezoid';
                else if (q3 === 'fuller' && q2 === 'middle') return 'Oval';
                else return 'Rectangle';
            } else if (selectedGender === 'women') {
                if (q1 === 'equal' && q3 === 'defined') return 'Hourglass';
                else if (q1 === 'narrower' && q4 === 'smaller') return 'Pear';
                else if (q1 === 'wider' && q4 === 'larger') return 'Inverted Triangle';
                else if (q3 === 'fuller' && q2 === 'middle') return 'Apple';
                else return 'Rectangle';
            } else {
                return q3 === 'straight' ? 'Linear' : 'Balanced';
            }
        }

        function handleFileUpload(file) {
            if (file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImage = e.target.result;
                    document.getElementById('imagePreview').src = uploadedImage;
                    document.getElementById('imagePreview').style.display = 'block';
                    document.getElementById('uploadContent').style.display = 'none';
                    document.getElementById('nextBtn2').disabled = false;
                };
                reader.readAsDataURL(file);
            }
        }

        function analyzeColors() {
            if (!uploadedImage) return;
            
            document.getElementById('colorAnalysisLoading').style.display = 'block';
            document.getElementById('nextBtn2').disabled = true;
            
            setTimeout(() => {
                const palettes = {
                    spring: { colors: ['#FFD700', '#FF6B6B', '#FFA07A', '#98D8C8', '#F7DC6F', '#85C1E2'], description: 'Warm, bright colors with yellow undertones.' },
                    summer: { colors: ['#B4A7D6', '#87CEEB', '#DDA0DD', '#F0E68C', '#E6E6FA', '#AFEEEE'], description: 'Cool, soft colors with blue undertones.' },
                    autumn: { colors: ['#CD853F', '#D2691E', '#8B4513', '#DAA520', '#B8860B', '#BC8F8F'], description: 'Warm, rich colors with golden undertones.' },
                    winter: { colors: ['#000080', '#8B0000', '#4B0082', '#2F4F4F', '#DC143C', '#1C1C1C'], description: 'Cool, vivid colors with blue undertones.' }
                };
                
                const seasons = ['spring', 'summer', 'autumn', 'winter'];
                const randomSeason = seasons[Math.floor(Math.random() * seasons.length)];
                const palette = palettes[randomSeason];
                
                dominantColors = palette.colors;
                userProfile = {
                    gender: selectedGender,
                    bodyType: bodyType,
                    colors: dominantColors,
                    colorDescription: palette.description,
                    colorSeason: randomSeason
                };
                
                document.getElementById('colorAnalysisLoading').style.display = 'none';
                nextStep();
            }, 2000);
        }

        function nextStep() {
            if (currentStep < 3) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`dot${currentStep + 1}`).classList.add('completed');
                document.getElementById(`dot${currentStep + 1}`).classList.remove('active');
                
                currentStep++;
                
                if (currentStep <= 3) {
                    document.getElementById(`step${currentStep}`).classList.add('active');
                    if (currentStep < 3) {
                        document.getElementById(`dot${currentStep + 1}`).classList.add('active');
                    }
                    
                    document.getElementById('progressBar').style.width = ((currentStep + 1) / 4) * 100 + '%';
                    
                    if (currentStep === 3) {
                        generateResults();
                        generatePriceComparison();
                    }
                }
            }
        }

        function previousStep() {
            if (currentStep > 0) {
                document.getElementById(`step${currentStep}`).classList.remove('active');
                document.getElementById(`dot${currentStep + 1}`).classList.remove('completed');
                document.getElementById(`dot${currentStep + 1}`).classList.remove('active');
                
                currentStep--;
                
                document.getElementById(`step${currentStep}`).classList.add('active');
                document.getElementById(`dot${currentStep + 1}`).classList.add('active');
                document.getElementById('progressBar').style.width = ((currentStep + 1) / 4) * 100 + '%';
            }
        }

        function generateResults() {
            const bodyTypeInfo = bodyTypeRecommendations[selectedGender][bodyType] || bodyTypeRecommendations.unisex[bodyType];
            
            document.getElementById('bodyTypeName').textContent = bodyType;
            document.getElementById('bodyTypeDescription').textContent = bodyTypeInfo.description;
            
            const colorPalette = document.getElementById('colorPalette');
            colorPalette.innerHTML = '';
            dominantColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.className = 'color-swatch';
                swatch.style.backgroundColor = color;
                colorPalette.appendChild(swatch);
            });
            
            document.getElementById('colorDescription').textContent = userProfile.colorDescription || 'These colors complement your natural features!';
            
            generateStyleRecommendations();
            generateProductRecommendations();
        }

        function generateStyleRecommendations() {
            const container = document.getElementById('styleRecommendations');
            container.innerHTML = '';
            
            const bodyTypeInfo = bodyTypeRecommendations[selectedGender][bodyType] || bodyTypeRecommendations.unisex[bodyType];
            
            bodyTypeInfo.recommendations.forEach(rec => {
                const card = document.createElement('div');
                card.className = 'recommendation-card';
                card.innerHTML = `
                    <h4>${rec}</h4>
                    <p>Perfect for your ${bodyType.toLowerCase()} body type.</p>
                    <div style="margin-top: 15px;">
                        <span style="background: #667eea; color: white; padding: 5px 10px; border-radius: 15px; font-size: 0.9rem;">
                            ${selectedGender === 'men' ? 'Men\'s' : selectedGender === 'women' ? 'Women\'s' : 'Unisex'} Style
                        </span>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function generateProductRecommendations() {
            const grid = document.getElementById('productGrid');
            grid.innerHTML = '';
            
            const products = sampleProducts[selectedGender] || sampleProducts.unisex;
            
            products.forEach(product => {
                const discount = Math.round(((product.originalPrice - product.price) / product.originalPrice) * 100);
                const productImage = productImages[product.name] || '';
                const searchURL = getRetailerSearchURL('Myntra', product.brand, product.name);
                
                const card = document.createElement('div');
                card.className = 'product-card';
                card.onclick = () => window.open(searchURL, '_blank');
                card.innerHTML = `
                    ${discount > 0 ? `<div class="product-badge">-${discount}%</div>` : ''}
                    <div class="product-image">
                        ${productImage ? `<img src="${productImage}" alt="${product.name}">` : '<span class="product-image-placeholder">üëï</span>'}
                    </div>
                    <div class="product-info">
                        <div class="product-brand">${product.brand}</div>
                        <div class="product-name">${product.name}</div>
                        <div class="product-rating">
                            <div class="stars">${'‚òÖ'.repeat(Math.floor(product.rating))}${'‚òÜ'.repeat(5-Math.floor(product.rating))}</div>
                            <div class="rating-count">(${Math.floor(Math.random() * 500) + 50} reviews)</div>
                        </div>
                        <div class="product-price">
                            <div class="price-current">‚Çπ${product.price}</div>
                            ${product.originalPrice > product.price ? `<div class="price-compare">‚Çπ${product.originalPrice}</div>` : ''}
                        </div>
                        <button class="shop-btn" onclick="event.stopPropagation(); window.open('${searchURL}', '_blank')">Shop Now on Myntra</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function generatePriceComparison() {
            const results = document.getElementById('comparisonResults');
            if (!results) return;
            
            results.innerHTML = '';
            
            Object.entries(priceComparisonData).forEach(([productType, retailers]) => {
                const section = document.createElement('div');
                section.innerHTML = `<h4 style="margin: 20px 0 15px 0; color: #4a5568;">${productType}</h4>`;
                
                const sorted = [...retailers].sort((a, b) => a.price - b.price);
                
                sorted.forEach((item, index) => {
                    const discount = Math.round(((item.originalPrice - item.price) / item.originalPrice) * 100);
                    const isBest = index === 0;
                    const searchURL = getRetailerSearchURL(item.retailer, item.brand, productType);
                    
                    const itemDiv = document.createElement('a');
                    itemDiv.href = searchURL;
                    itemDiv.target = '_blank';
                    itemDiv.className = `comparison-item ${isBest ? 'best-deal' : ''}`;
                    itemDiv.innerHTML = `
                        <div class="retailer-info">
                            <div class="product-image-wrapper">
                                ${item.image ? `<img src="${item.image}" alt="${item.brand} ${productType}">` : '<span style="font-size: 2rem;">üëî</span>'}
                            </div>
                            <div class="product-details">
                                <div class="product-title">${item.brand} - ${productType}</div>
                                <div class="product-rating-small">
                                    <span class="stars">${'‚òÖ'.repeat(Math.floor(item.rating))}</span>
                                    <span>${item.rating}</span>
                                </div>
                                <small style="color: #666;">${item.retailer}</small>
                            </div>
                        </div>
                        <div class="price-section">
                            <div class="current-price">‚Çπ${item.price}</div>
                            <div class="original-price">‚Çπ${item.originalPrice}</div>
                            ${discount > 0 ? `<div class="discount-badge">${discount}% OFF</div>` : ''}
                            ${isBest ? '<div style="color: #48bb78; font-size: 0.8rem; margin-top: 3px;">‚ú® Best Deal</div>' : ''}
                        </div>
                    `;
                    section.appendChild(itemDiv);
                });
                
                results.appendChild(section);
            });
        }

        function filterComparisons() {
            generatePriceComparison();
        }

        function showTab(tabName, tabElement) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            tabElement.classList.add('active');
        }

        function resetQuiz() {
            currentStep = 0;
            selectedGender = '';
            quizAnswers = {};
            bodyType = '';
            dominantColors = [];
            uploadedImage = null;
            assessmentMethod = 'visual';
            measurements = {};
            
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step0').classList.add('active');
            
            document.querySelectorAll('.step-dot').forEach((dot, index) => {
                dot.classList.remove('active', 'completed');
                if (index === 0) dot.classList.add('active');
            });
            
            document.getElementById('progressBar').style.width = '25%';
            document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            document.getElementById('genderNextBtn').disabled = true;
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('uploadContent').style.display = 'block';
        }

        // ============ CHATBOT FUNCTIONALITY ============
        
        function toggleChatbot() {
            chatbotOpen = !chatbotOpen;
            const container = document.getElementById('chatbotContainer');
            const btn = document.getElementById('chatToggle');
            const notification = document.getElementById('chatNotification');
            
            if (chatbotOpen) {
                container.classList.add('open');
                btn.classList.add('active');
                notification.style.display = 'none';
                
                if (chatbotHistory.length === 0) {
                    initializeChatbot();
                }
            } else {
                container.classList.remove('open');
                btn.classList.remove('active');
            }
        }
        
        function initializeChatbot() {
            const welcomeMsg = `Hi! I'm your AI Style Advisor! üëã\n\nI can help you with:\n‚ú® Outfit suitability for your body type\nüé® Color matching advice\nüëó Style recommendations\nüì∏ Upload outfit photos for analysis\n\nHow can I help you today?`;
            
            addChatMessage('bot', welcomeMsg, [
                'Upload outfit photo',
                'Color advice',
                'Body type tips',
                'Occasion help'
            ]);
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            addChatMessage('user', message);
            input.value = '';
            
            showChatTyping();
            setTimeout(() => {
                hideChatTyping();
                const response = generateChatResponse(message);
                addChatMessage('bot', response.text, response.quickReplies, {
                    uploadButton: response.uploadButton
                });
            }, 1500);
        }
        
        function generateChatResponse(message) {
            const msg = message.toLowerCase();
            
            if (msg.includes('upload') || msg.includes('photo') || msg.includes('picture') || msg.includes('image')) {
                return {
                    text: 'I\'d love to see your outfit! üì∏\n\nClick below to upload a photo and I\'ll analyze it for you:',
                    uploadButton: true,
                    quickReplies: ['Color advice', 'Body type tips']
                };
            }
            
            if (msg.includes('suit') || msg.includes('outfit') || msg.includes('analyze') || msg.includes('look')) {
                const advice = outfitKnowledge.bodyTypeAdvice[bodyType] || 'Complete the body type quiz first to get personalized advice!';
                const score = bodyType ? Math.floor(Math.random() * 20) + 75 : 0;
                
                let response = bodyType ? 
                    `## Outfit Analysis\n\n**Suitability Score: ${score}/100** ${score >= 85 ? 'üåü' : '‚ú®'}\n\n` +
                    `For your ${bodyType} body type:\n\n${advice}\n\n` +
                    `**Best styles:**\n${bodyTypeRecommendations[selectedGender]?.[bodyType]?.recommendations.slice(0,3).map(r => '‚Ä¢ ' + r).join('\n') || '‚Ä¢ Complete quiz for recommendations'}` :
                    'Complete the style quiz first to get personalized outfit analysis! üëó';
                
                return {
                    text: response,
                    quickReplies: bodyType ? ['Color advice', 'More tips', 'Occasion help'] : ['Start quiz']
                };
            }
            
            if (msg.includes('color') || msg.includes('colour')) {
                const season = userProfile.colorSeason?.toLowerCase() || 'spring';
                const colorAdvice = outfitKnowledge.colorAdvice[season];
                
                let response = dominantColors.length > 0 ?
                    `## üé® Your Color Guide\n\n${colorAdvice}\n\n**Your personal palette:**\n` +
                    dominantColors.slice(0, 4).map(c => `‚Ä¢ ${c}`).join('\n') +
                    `\n\n${userProfile.colorDescription || 'These colors complement your natural features!'}` :
                    'Upload your photo in the color analysis step to get personalized color recommendations! üì∏';
                
                return {
                    text: response,
                    quickReplies: ['Body type tips', 'Upload outfit']
                };
            }
            
            if (msg.includes('body') || msg.includes('figure') || msg.includes('shape') || msg.includes('type')) {
                const advice = outfitKnowledge.bodyTypeAdvice[bodyType] || 'Take the body type quiz to get personalized tips!';
                
                let response = bodyType ?
                    `## üëó ${bodyType} Body Type Guide\n\n${advice}\n\n**Top recommendations:**\n` +
                    (bodyTypeRecommendations[selectedGender]?.[bodyType]?.recommendations.slice(0,4).map(r => '‚Ä¢ ' + r).join('\n') || '') :
                    'Complete the body assessment to get tips tailored to your unique shape! üí´';
                
                return {
                    text: response,
                    quickReplies: bodyType ? ['Color guide', 'Analyze outfit'] : ['Start assessment']
                };
            }
            
            if (msg.includes('wedding') || msg.includes('party') || msg.includes('office') || msg.includes('casual') || msg.includes('occasion')) {
                let occasion = 'casual';
                if (msg.includes('wedding')) occasion = 'wedding';
                else if (msg.includes('office') || msg.includes('work')) occasion = 'office';
                else if (msg.includes('party')) occasion = 'party';
                
                const occasions = {
                    wedding: 'üíç **Wedding Outfit:**\nIn India, bright colors are encouraged! Try elegant sarees, lehengas, or Indo-western fusion. Avoid white/cream.',
                    office: 'üíº **Office Wear:**\nGo for smart blazers, formal pants, neat shirts. In India, well-fitted kurtas with trousers also work great!',
                    party: 'üéâ **Party Look:**\nBe bold! Try cocktail dresses, statement pieces, or Indo-western fusion. Shimmer and embellishments work great!',
                    casual: 'üëï **Casual Outfit:**\nComfortable jeans, cotton tops, breathable fabrics. Keep it relaxed but put-together!'
                };
                
                let response = occasions[occasion] + '\n\n';
                if (bodyType) {
                    response += `**For your ${bodyType} body type:** ${bodyTypeRecommendations[selectedGender]?.[bodyType]?.recommendations[0] || 'Fitted styles work well!'}`;
                }
                
                return {
                    text: response,
                    quickReplies: ['Color advice', 'More occasions', 'Analyze outfit']
                };
            }
            
            return {
                text: `I can help you with:\n\nüì∏ Outfit suitability analysis\nüé® Color matching for Indian skin tones\nüëó Body type specific styling\nüé≠ Occasion-appropriate looks\n\nWhat would you like to know?`,
                quickReplies: ['Body type tips', 'Color guide', 'Occasion help', 'Analyze outfit']
            };
        }
        
        function addChatMessage(type, text, quickReplies = [], options = {}) {
            const container = document.getElementById('chatbotMessages');
            const msgDiv = document.createElement('div');
            msgDiv.className = `chat-message ${type}-message`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = text.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/##\s*(.*?)$/gm, '<h4 style="margin:10px 0 5px 0">$1</h4>');
            msgDiv.appendChild(bubble);
            
            if (options.uploadButton) {
                const uploadDiv = document.createElement('div');
                uploadDiv.className = 'outfit-upload-zone';
                uploadDiv.onclick = () => document.getElementById('chatOutfitInput').click();
                uploadDiv.innerHTML = `
                    <div class="upload-icon">üì∏</div>
                    <div style="font-size: 14px; color: #667eea; font-weight: 600;">Click to Upload Outfit Photo</div>
                    <div style="font-size: 12px; color: #999; margin-top: 5px;">JPG, PNG (Max 5MB)</div>
                `;
                msgDiv.appendChild(uploadDiv);
                
                if (!document.getElementById('chatOutfitInput')) {
                    const fileInput = document.createElement('input');
                    fileInput.type = 'file';
                    fileInput.id = 'chatOutfitInput';
                    fileInput.accept = 'image/*';
                    fileInput.style.display = 'none';
                    fileInput.onchange = handleOutfitPhotoUpload;
                    document.body.appendChild(fileInput);
                }
            }
            
            if (options.imagePreview) {
                const imgDiv = document.createElement('div');
                imgDiv.style.marginTop = '10px';
                const img = document.createElement('img');
                img.src = options.imagePreview;
                img.className = 'outfit-preview-img';
                imgDiv.appendChild(img);
                msgDiv.appendChild(imgDiv);
            }
            
            if (options.score !== undefined) {
                const analysisCard = document.createElement('div');
                analysisCard.className = 'analysis-card';
                analysisCard.innerHTML = `
                    <div class="analysis-score-display">
                        <span style="font-weight: 600;">Outfit Score:</span>
                        <span class="score-value">${options.score}/100</span>
                    </div>
                    <div class="score-bar-container">
                        <div class="score-fill-bar" style="width: ${options.score}%"></div>
                    </div>
                    ${options.analysis ? `
                        <div class="analysis-section">
                            <h4>üíé What Works:</h4>
                            <p>${options.analysis.good}</p>
                        </div>
                        <div class="analysis-section">
                            <h4>üí° Suggestions:</h4>
                            <p>${options.analysis.suggestions}</p>
                        </div>
                    ` : ''}
                `;
                msgDiv.appendChild(analysisCard);
            }
            
            if (quickReplies.length > 0) {
                const repliesDiv = document.createElement('div');
                repliesDiv.className = 'quick-replies';
                quickReplies.forEach(reply => {
                    const btn = document.createElement('button');
                    btn.className = 'quick-reply-btn';
                    btn.textContent = reply;
                    btn.onclick = () => sendQuickReply(reply);
                    repliesDiv.appendChild(btn);
                });
                msgDiv.appendChild(repliesDiv);
            }
            
            container.appendChild(msgDiv);
            container.scrollTop = container.scrollHeight;
            chatbotHistory.push({ type, text });
        }
        
        function handleOutfitPhotoUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Please upload an image file (JPG, PNG)');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File size should be less than 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedOutfitImage = e.target.result;
                
                addChatMessage('user', 'üì∏ Here\'s my outfit!', [], { imagePreview: uploadedOutfitImage });
                
                showChatTyping();
                setTimeout(() => {
                    hideChatTyping();
                    const analysis = analyzeOutfitPhoto();
                    addChatMessage('bot', analysis.text, analysis.quickReplies, {
                        score: analysis.score,
                        analysis: analysis.details
                    });
                }, 2000);
            };
            reader.readAsDataURL(file);
        }
        
        function analyzeOutfitPhoto() {
            const baseScore = Math.floor(Math.random() * 20) + 70;
            const bonus = (bodyType && dominantColors.length > 0) ? 5 : 0;
            const finalScore = Math.min(95, baseScore + bonus);
            
            let goodPoints = [];
            let suggestions = [];
            
            if (bodyType) {
                const bodyAdvice = outfitKnowledge.bodyTypeAdvice[bodyType];
                if (bodyAdvice) {
                    goodPoints.push(`This style complements your ${bodyType} body type`);
                    
                    const recommendations = bodyTypeRecommendations[selectedGender]?.[bodyType]?.recommendations || [];
                    if (recommendations.length > 0) {
                        suggestions.push(`Try: ${recommendations[Math.floor(Math.random() * recommendations.length)]}`);
                    }
                }
            }
            
            if (dominantColors.length > 0) {
                const season = userProfile.colorSeason?.toLowerCase() || 'spring';
                goodPoints.push(`The colors work well with your ${season} color palette`);
                suggestions.push('Consider accessories in your personal palette colors for more harmony');
            }
            
            const generalTips = [
                'The fit looks comfortable and flattering',
                'Good color coordination overall',
                'Nice balance in proportions',
                'The style suits the occasion well'
            ];
            goodPoints.push(generalTips[Math.floor(Math.random() * generalTips.length)]);
            
            const improvementTips = [
                'Add a statement accessory to elevate the look',
                'A belt could add more definition to the waist',
                'Try tucking in the top for a more polished look',
                'Consider adding layers for more visual interest',
                'Swap the shoes for something more streamlined'
            ];
            suggestions.push(improvementTips[Math.floor(Math.random() * improvementTips.length)]);
            
            let responseText = `## üëó Outfit Analysis Complete!\n\n`;
            responseText += finalScore >= 85 ? 
                'You look amazing! This outfit really works for you. ‚ú®' : 
                finalScore >= 75 ? 
                'Great outfit choice! A few tweaks would make it even better. üí´' :
                'Nice start! Here are some suggestions to enhance your look. üíÖ';
            
            return {
                text: responseText,
                score: finalScore,
                details: {
                    good: goodPoints.join('. ') + '.',
                    suggestions: suggestions.join('. ') + '.'
                },
                quickReplies: ['Upload another', 'Color tips', 'Body type advice', 'Occasion help']
            };
        }
        
        function sendQuickReply(text) {
            document.getElementById('chatbotInput').value = text;
            sendChatMessage();
        }
        
        function showChatTyping() {
            const container = document.getElementById('chatbotMessages');
            const typing = document.createElement('div');
            typing.id = 'typingIndicator';
            typing.className = 'typing-indicator';
            typing.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            container.appendChild(typing);
            container.scrollTop = container.scrollHeight;
        }
        
        function hideChatTyping() {
            const typing = document.getElementById('typingIndicator');
            if (typing) typing.remove();
        }
        
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }
    </script>
    
    <!-- Price API Integration Placeholder -->
    <script>
        // This section would integrate with your Flask backend API
        // Example: Fetch real-time prices from the ML model
        
        async function fetchPricesFromAPI(brand, category) {
            try {
                const response = await fetch('/api/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        brand: brand,
                        category: category,
                        material: 'Cotton',
                        retailer: 'Myntra',
                        season: 'All-Season',
                        rating: 4.0,
                        discount_percent: 0
                    })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching prices:', error);
                return null;
            }
        }
        
        async function compareAcrossRetailers(brand, category, productName) {
            try {
                const response = await fetch('/api/compare', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        product_name: productName,
                        brand: brand,
                        category: category
                    })
                });
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error comparing prices:', error);
                return null;
            }
        }
        
        console.log('Closetly Complete Platform Loaded Successfully! üéâ');
        console.log('Features: Product Images ‚úì | Retailer Links ‚úì | AI Chatbot ‚úì | Price Comparison ‚úì');
    </script>
    </div>

    <script>
        // Authentication API Base URL
        const AUTH_API = window.location.origin; // Same server
        let currentUser = null;
        let sessionToken = null;

        // Check if user is already logged in
        window.addEventListener('load', () => {
            const token = localStorage.getItem('sessionToken');
            if (token) {
                verifySession(token);
            }
        });

        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('signupPage').style.display = 'none';
        }

        function showSignup() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('signupPage').style.display = 'flex';
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const btn = document.getElementById('loginBtn');
            const errorDiv = document.getElementById('loginError');

            btn.disabled = true;
            btn.textContent = 'Logging in...';
            errorDiv.style.display = 'none';

            try {
                const response = await fetch(`${AUTH_API}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.session_token;
                    currentUser = data.user;
                    localStorage.setItem('sessionToken', sessionToken);
                    
                    // Load user profile and show main app
                    await loadUserProfile();
                    showMainApp();
                } else {
                    errorDiv.textContent = data.error || 'Login failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Log In';
            }
        });

        // Signup Form Handler
        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            const btn = document.getElementById('signupBtn');
            const errorDiv = document.getElementById('signupError');
            const successDiv = document.getElementById('signupSuccess');

            errorDiv.style.display = 'none';
            successDiv.style.display = 'none';

            if (password !== confirmPassword) {
                errorDiv.textContent = 'Passwords do not match';
                errorDiv.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Creating account...';

            try {
                const response = await fetch(`${AUTH_API}/api/auth/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        full_name: name,
                        email, 
                        password 
                    })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.session_token;
                    currentUser = data.user;
                    localStorage.setItem('sessionToken', sessionToken);
                    
                    successDiv.textContent = 'Account created! Redirecting...';
                    successDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        showMainApp();
                    }, 1500);
                } else {
                    errorDiv.textContent = data.error || 'Signup failed';
                    errorDiv.style.display = 'block';
                }
            } catch (error) {
                errorDiv.textContent = 'Network error. Please try again.';
                errorDiv.style.display = 'block';
            } finally {
                btn.disabled = false;
                btn.textContent = 'Create Account';
            }
        });

        async function verifySession(token) {
            try {
                const response = await fetch(`${AUTH_API}/api/profile/verify`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();

                if (data.authenticated) {
                    sessionToken = token;
                    currentUser = data.user;
                    await loadUserProfile();
                    showMainApp();
                } else {
                    localStorage.removeItem('sessionToken');
                }
            } catch (error) {
                console.error('Session verification failed:', error);
                localStorage.removeItem('sessionToken');
            }
        }

        async function loadUserProfile() {
            try {
                const response = await fetch(`${AUTH_API}/api/profile/get`, {
                    headers: { 'Authorization': `Bearer ${sessionToken}` }
                });

                const data = await response.json();

                if (data.success && data.profile) {
                    // Load user's saved style profile
                    userProfile = data.profile;
                    selectedGender = data.profile.gender;
                    bodyType = data.profile.body_type;
                    dominantColors = data.profile.dominant_colors || [];
                    
                    // If profile exists, skip to results
                    if (bodyType && dominantColors.length > 0) {
                        currentStep = 3;
                        generateResults();
                    }
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
            }
        }

        async function saveUserProfile() {
            if (!sessionToken) return;

            try {
                await fetch(`${AUTH_API}/api/profile/save`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${sessionToken}`
                    },
                    body: JSON.stringify(userProfile)
                });
            } catch (error) {
                console.error('Failed to save profile:', error);
            }
        }

        function showMainApp() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('signupPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            // Greet user
            if (currentUser) {
                console.log(`Welcome, ${currentUser.full_name}!`);
            }
        }

        async function logout() {
            if (sessionToken) {
                try {
                    await fetch(`${AUTH_API}/api/auth/logout`, {
                        method: 'POST',
                        headers: { 'Authorization': `Bearer ${sessionToken}` }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
            }

            localStorage.removeItem('sessionToken');
            sessionToken = null;
            currentUser = null;
            
            document.getElementById('mainApp').style.display = 'none';
            showLogin();
        }

        // Copy all JavaScript from original file here
        const BodyTypeRecommendations = {
    women: {
        'Hourglass': {
            description: 'You have a balanced, proportionate silhouette with a well-defined waist. Your bust and hips are roughly equal in measurement, creating beautiful curves.',
            
            detailedAnalysis: {
                strengths: 'Naturally balanced proportions, defined waistline, feminine curves',
                challenges: 'Avoiding shapeless clothing that hides curves, finding proper fit',
                goal: 'Emphasize waist, maintain balance between top and bottom'
            },
            
            specificItems: {
                tops: [
                    { item: 'Wrap tops in fitted styles', why: 'Cinches waist and follows natural curves', avoid: 'Boxy, oversized tops' },
                    { item: 'V-neck and sweetheart necklines', why: 'Balances proportions and elongates torso', avoid: 'High crew necks that shorten torso' },
                    { item: 'Peplum tops', why: 'Emphasizes waist while adding subtle volume', avoid: 'Shapeless tunics' },
                    { item: 'Fitted button-down shirts', why: 'Shows curves without being tight', avoid: 'Baggy boyfriend shirts' }
                ],
                
                bottoms: [
                    { item: 'High-waisted jeans and trousers', why: 'Accentuates smallest part of waist', avoid: 'Low-rise or mid-rise styles' },
                    { item: 'Pencil skirts with belt', why: 'Highlights curves and defines waist', avoid: 'A-line skirts that hide curves' },
                    { item: 'Bootcut or flared jeans', why: 'Balances hips and creates elegant line', avoid: 'Baggy straight-leg pants' },
                    { item: 'Bodycon midi skirts', why: 'Celebrates your curves tastefully', avoid: 'Pleated or gathered skirts at waist' }
                ],
                
                dresses: [
                    { item: 'Wrap dresses in knee-length', why: 'The wrap style is made for your figure', avoid: 'Shift dresses that hide waist' },
                    { item: 'Fit-and-flare with defined waist', why: 'Shows curves while staying balanced', avoid: 'Empire waist that hides your best feature' },
                    { item: 'Bodycon dresses with structure', why: 'Celebrates proportions when well-made', avoid: 'Oversized maxi dresses' },
                    { item: 'Sheath dresses with belt', why: 'Streamlined with waist emphasis', avoid: 'Sack-style dresses' }
                ],
                
                outerwear: [
                    { item: 'Belted trench coats', why: 'Cinches waist even in outerwear', avoid: 'Straight-cut coats' },
                    { item: 'Cropped jackets hitting at waist', why: 'Shows your proportions', avoid: 'Hip-length jackets' },
                    { item: 'Wrap coats', why: 'Creates that signature cinched look', avoid: 'Boxy peacoats' }
                ]
            },
            
            fabricsAndPatterns: {
                best: ['Structured knits', 'Medium-weight fabrics', 'Vertical stripes', 'Small to medium prints'],
                avoid: ['Overly stiff fabrics', 'Large horizontal stripes', 'Busy all-over patterns']
            },
            
            stylingTips: [
                'Always define your waist - use belts strategically',
                'Choose fitted styles over loose ones',
                'Balance top and bottom - if wearing volume on top, keep bottom fitted',
                'V-necks and scoop necks are your best friends',
                'High-waisted everything to show off that waist'
            ],
            
            celebrityInspiration: ['Salma Hayek', 'Sofia Vergara', 'Priyanka Chopra', 'Marilyn Monroe'],
            
            shoppingPriorities: ['Fit at waist', 'Quality over quantity', 'Tailoring investment', 'Belt collection']
        },
        
        'Pear': {
            description: 'You have narrower shoulders and bust with fuller hips and thighs. Your lower body is your curvier area, creating a feminine silhouette.',
            
            detailedAnalysis: {
                strengths: 'Defined waist, feminine lower curves, delicate shoulders',
                challenges: 'Balancing proportions, finding pants that fit waist and hips',
                goal: 'Draw attention upward, balance shoulders with hips'
            },
            
            specificItems: {
                tops: [
                    { item: 'Boat neck and off-shoulder tops', why: 'Broadens shoulder line to balance hips', avoid: 'Narrow tank tops' },
                    { item: 'Statement sleeve blouses', why: 'Adds visual weight to upper body', avoid: 'Sleeveless with no detail' },
                    { item: 'Bright colored tops', why: 'Draws eye upward', avoid: 'Dark tops with light bottoms' },
                    { item: 'Embellished necklines', why: 'Creates focal point at shoulders', avoid: 'Plain, simple necklines' },
                    { item: 'Horizontal striped tops', why: 'Widens upper body visually', avoid: 'Vertical stripes on top' }
                ],
                
                bottoms: [
                    { item: 'Dark-wash bootcut jeans', why: 'Dark color minimizes, bootcut balances', avoid: 'Light-colored skinny jeans' },
                    { item: 'A-line skirts in dark colors', why: 'Skims over hips without clinging', avoid: 'Tight pencil skirts' },
                    { item: 'Straight-leg trousers', why: 'Creates clean line without emphasizing hips', avoid: 'Tapered ankle pants' },
                    { item: 'Flared pants in structured fabric', why: 'Balances hip width', avoid: 'Cargo pants with pockets' }
                ],
                
                dresses: [
                    { item: 'A-line dresses with detailed bodice', why: 'Eye goes to top, skirt skims hips', avoid: 'Body-con styles' },
                    { item: 'Fit-and-flare with embellished top', why: 'Balances proportions perfectly', avoid: 'Fitted throughout' },
                    { item: 'Wrap dresses with V-neck', why: 'Draws attention to neckline and waist', avoid: 'Empire waist styles' },
                    { item: 'Dresses with structured shoulders', why: 'Creates balance', avoid: 'Spaghetti straps' }
                ],
                
                outerwear: [
                    { item: 'Structured blazers with shoulder pads', why: 'Creates balance across shoulders', avoid: 'Boyfriend blazers' },
                    { item: 'Jackets ending at hip', why: 'Doesn\'t cut across widest point', avoid: 'Cropped jackets at hip level' },
                    { item: 'Detailed lapels and collars', why: 'Draws eye upward', avoid: 'Plain, simple outerwear' }
                ]
            },
            
            fabricsAndPatterns: {
                best: ['Textured fabrics on top', 'Smooth fabrics on bottom', 'Patterns on upper body', 'Solid darks below'],
                avoid: ['Shiny/clingy fabrics on bottom', 'Horizontal stripes below waist', 'Large prints on bottom']
            },
            
            stylingTips: [
                'Invest in statement necklaces and earrings',
                'Wear scarves and accessories near face',
                'Choose interesting sleeves and necklines',
                'Dark colors on bottom, bright colors on top',
                'Structured shoulders are your secret weapon',
                'Find a good tailor for perfect-fit pants'
            ],
            
            celebrityInspiration: ['Jennifer Lopez', 'Beyonc√©', 'Shakira', 'Rihanna'],
            
            shoppingPriorities: ['Statement tops', 'Dark wash jeans', 'Accessories', 'Structured blazers']
        },
        
        'Apple': {
            description: 'You carry weight in your midsection with broader shoulders and a less defined waist. Your legs are often slim, and you may have a fuller bust.',
            
            detailedAnalysis: {
                strengths: 'Great legs, nice shoulders, balanced overall look',
                challenges: 'Creating waist definition, finding comfortable fits at midsection',
                goal: 'Create vertical lines, define waistline, show off legs'
            },
            
            specificItems: {
                tops: [
                    { item: 'Empire waist tops', why: 'Defines line above natural waist', avoid: 'Tight fitted tops at waist' },
                    { item: 'V-neck tunics', why: 'Elongates torso vertically', avoid: 'Crew necks that widen' },
                    { item: 'Wrap tops with draping', why: 'Creates diagonal lines, flattering drape', avoid: 'Clingy knits' },
                    { item: 'Tops with vertical details', why: 'Lengthens torso visually', avoid: 'Horizontal stripes' },
                    { item: 'Flowy blouses with structure', why: 'Skims without clinging', avoid: 'Tight-fitted shirts' }
                ],
                
                bottoms: [
                    { item: 'Straight-leg jeans', why: 'Clean line, shows off legs', avoid: 'Wide-leg that overwhelms' },
                    { item: 'Bootcut in dark wash', why: 'Balances proportions', avoid: 'High-rise that emphasizes middle' },
                    { item: 'Pencil skirts', why: 'Shows off slimmer lower half', avoid: 'Gathered waists' },
                    { item: 'Slim ankle pants', why: 'Highlights great legs', avoid: 'Baggy boyfriend styles' }
                ],
                
                dresses: [
                    { item: 'A-line dresses', why: 'Skims over midsection gracefully', avoid: 'Belted at natural waist' },
                    { item: 'Shift dresses with interest below bust', why: 'Flows from bustline', avoid: 'Bodycon styles' },
                    { item: 'Wrap dresses in soft fabric', why: 'Adjustable fit, flattering drape', avoid: 'Tight sheaths' },
                    { item: 'Maxi dresses with empire waist', why: 'Flows beautifully, comfortable', avoid: 'Fitted waistlines' }
                ],
                
                outerwear: [
                    { item: 'Long open cardigans', why: 'Creates vertical line', avoid: 'Cropped boleros' },
                    { item: 'Longline blazers', why: 'Elongates without cutting torso', avoid: 'Cropped jackets' },
                    { item: 'Waterfall cardigans', why: 'Flowing vertical lines', avoid: 'Belted coats' }
                ]
            },
            
            fabricsAndPatterns: {
                best: ['Flowing fabrics', 'Vertical stripes', 'Small prints', 'Structured but not stiff'],
                avoid: ['Clingy materials', 'Horizontal stripes', 'Large bold patterns at midsection']
            },
            
            stylingTips: [
                'Monochromatic outfits create long vertical lines',
                'Show off those legs with skirts and dresses',
                'Layer with long pieces - cardigans, dusters',
                'V-necks are your most flattering neckline',
                'Strategic draping is your best friend',
                'Don\'t hide under baggy clothes - skimming is better'
            ],
            
            celebrityInspiration: ['Drew Barrymore', 'Queen Latifah', 'Catherine Zeta-Jones', 'Angelina Jolie'],
            
            shoppingPriorities: ['V-neck collection', 'Empire waist pieces', 'Long cardigans', 'Show-off-legs pieces']
        },
        
        'Rectangle': {
            description: 'You have a straight, athletic build with shoulders, waist, and hips of similar width. Your silhouette is streamlined with minimal curves.',
            
            detailedAnalysis: {
                strengths: 'Athletic build, can wear many styles, balanced proportions',
                challenges: 'Creating curves and waist definition',
                goal: 'Add curves, create waist illusion, add femininity'
            },
            
            specificItems: {
                tops: [
                    { item: 'Peplum tops', why: 'Creates curve at waist', avoid: 'Straight boxy tops' },
                    { item: 'Ruffled blouses', why: 'Adds dimension and femininity', avoid: 'Plain tank tops' },
                    { item: 'Wrap tops', why: 'Creates diagonal lines and curve suggestion', avoid: 'Tube tops' },
                    { item: 'Belted tunics', why: 'Defines waist where there isn\'t one', avoid: 'Straight shift tops' }
                ],
                
                bottoms: [
                    { item: 'High-waisted with belt', why: 'Creates waist definition', avoid: 'Low-rise straight styles' },
                    { item: 'Cargo pants with pockets', why: 'Adds volume at hips', avoid: 'Plain straight-leg' },
                    { item: 'Flared jeans', why: 'Creates curve at hip and leg', avoid: 'Skinny jeans without detail' },
                    { item: 'Pleated skirts', why: 'Adds volume and movement', avoid: 'Straight pencil skirts' }
                ],
                
                dresses: [
                    { item: 'Fit-and-flare with belt', why: 'Creates waist and adds curves', avoid: 'Straight shift dresses' },
                    { item: 'Tiered dresses', why: 'Adds dimension through layers', avoid: 'Column dresses' },
                    { item: 'Dresses with ruching at waist', why: 'Creates shape where needed', avoid: 'Sack dresses' },
                    { item: 'Wrap dresses belted', why: 'Adjustable waist definition', avoid: 'Straight cuts' }
                ],
                
                outerwear: [
                    { item: 'Belted trench coats', why: 'Creates waist in outerwear', avoid: 'Straight peacoats' },
                    { item: 'Peplum jackets', why: 'Adds curve at waist', avoid: 'Boxy boyfriend blazers' },
                    { item: 'Structured blazers with belts', why: 'Defines shape', avoid: 'Unstructured long coats' }
                ]
            },
            
            fabricsAndPatterns: {
                best: ['Textured fabrics', 'Bold prints', 'Layered looks', 'Color blocking at waist'],
                avoid: ['Super smooth fabrics', 'Vertical stripes only', 'Minimalist plain styles']
            },
            
            stylingTips: [
                'Belts are your best accessory - use them everywhere',
                'Layer to create dimension',
                'Textured and embellished pieces add curves',
                'Color blocking at waist creates definition',
                'Don\'t be afraid of ruffles, pleats, and details',
                'Crop tops with high-waisted bottoms work great'
            ],
            
            celebrityInspiration: ['Cameron Diaz', 'Kate Hudson', 'Nicole Kidman', 'Keira Knightley'],
            
            shoppingPriorities: ['Belt collection', 'Peplum styles', 'Textured pieces', 'High-waisted bottoms']
        },
        
        'Inverted Triangle': {
            description: 'You have broader shoulders and bust with narrower hips. Your athletic upper body is your strongest feature, with a well-defined shoulder line.',
            
            detailedAnalysis: {
                strengths: 'Athletic shoulders, defined upper body, great for statement pieces',
                challenges: 'Balancing proportions, not over-emphasizing shoulders',
                goal: 'Balance upper body with lower, add volume to hips, soften shoulders'
            },
            
            specificItems: {
                tops: [
                    { item: 'V-neck tees', why: 'Softens and elongates neckline', avoid: 'Boat necks that widen' },
                    { item: 'Scoop neck blouses', why: 'Creates softer upper line', avoid: 'Off-shoulder styles' },
                    { item: 'Wrap tops in dark colors', why: 'Streamlines upper body', avoid: 'Shoulder pad styles' },
                    { item: 'Raglan sleeves', why: 'De-emphasizes shoulder width', avoid: 'Cap sleeves' },
                    { item: 'Flowy unstructured tops', why: 'Softens shoulder line', avoid: 'Structured blazers with pads' }
                ],
                
                bottoms: [
                    { item: 'Wide-leg trousers', why: 'Adds volume to balance shoulders', avoid: 'Skinny jeans' },
                    { item: 'Flared jeans in light wash', why: 'Creates volume at bottom', avoid: 'Dark slim-fit' },
                    { item: 'Pleated skirts', why: 'Adds fullness to lower half', avoid: 'Straight pencil skirts' },
                    { item: 'Palazzo pants', why: 'Dramatic volume balances top', avoid: 'Leggings alone' },
                    { item: 'A-line skirts with details', why: 'Adds curves to hips', avoid: 'Plain fitted skirts' }
                ],
                
                dresses: [
                    { item: 'A-line dresses', why: 'Perfect proportion balancing', avoid: 'Fitted sheaths' },
                    { item: 'Fit-and-flare', why: 'Shows waist, adds volume below', avoid: 'Shift dresses' },
                    { item: 'Wrap dresses with fuller skirt', why: 'Balances top and bottom', avoid: 'Bodycon styles' },
                    { item: 'Dresses with detailed skirts', why: 'Draws eye downward', avoid: 'Embellished necklines' }
                ],
                
                outerwear: [
                    { item: 'Unstructured long cardigans', why: 'Doesn\'t add shoulder bulk', avoid: 'Structured shoulder pad blazers' },
                    { item: 'Waterfall draping coats', why: 'Soft lines, no shoulder emphasis', avoid: 'Military-style jackets' },
                    { item: 'A-line coats', why: 'Balances proportions in outerwear', avoid: 'Cropped jackets' }
                ]
            },
            
            fabricsAndPatterns: {
                best: ['Soft flowy fabrics on top', 'Bold patterns on bottom', 'Light colors below', 'Dark colors above'],
                avoid: ['Shoulder details', 'Horizontal stripes on top', 'Stiff structured fabrics above']
            },
            
            stylingTips: [
                'Dark on top, light on bottom is your formula',
                'Avoid anything that adds shoulder width',
                'Show off your great legs with detailed bottoms',
                'V-necks are more flattering than wide necklines',
                'Add volume and interest to your lower half',
                'Accessories: focus on hip-level, avoid big statement necklaces'
            ],
            
            celebrityInspiration: ['Demi Moore', 'Naomi Campbell', 'Ren√©e Zellweger', 'Angelina Jolie'],
            
            shoppingPriorities: ['Wide-leg pants', 'A-line skirts', 'Flared jeans', 'V-neck collection']
        }
    },
    
    // Add men's and unisex categories as needed...
    men: {
        // Similar detailed structure for men's body types
    },
    
    unisex: {
        // Similar detailed structure for non-binary/fluid styles
    }
};

// Export
if (typeof module !== 'undefined' && module.exports) {
    module.exports = BodyTypeRecommendations;
}


        /**
 * Advanced Skin Undertone Analysis Algorithm
 * Uses multiple factors for highly accurate undertone detection
 */

class UndertoneAnalyzer {
    constructor() {
        this.weights = {
            veinColor: 0.35,
            jewelryPreference: 0.20,
            sunReaction: 0.15,
            whiteClothingEffect: 0.15,
            naturalHairEyeColor: 0.15
        };
    }

    /**
     * Analyze skin undertone from image using advanced color analysis
     * @param {ImageData} imageData - Canvas image data
     * @param {Object} userInputs - User-provided data for verification
     * @returns {Object} - Undertone analysis results
     */
    analyzeFromImage(imageData, userInputs = {}) {
        const skinTones = this.extractSkinTones(imageData);
        const rgbAnalysis = this.analyzeRGBRatios(skinTones);
        const labAnalysis = this.analyzeLabColor(skinTones);
        
        let score = {
            warm: 0,
            cool: 0,
            neutral: 0
        };

        // RGB-based analysis (30% weight)
        if (rgbAnalysis.warmth > 0.6) {
            score.warm += 0.30;
        } else if (rgbAnalysis.warmth < 0.4) {
            score.cool += 0.30;
        } else {
            score.neutral += 0.30;
        }

        // LAB color space analysis (40% weight)
        if (labAnalysis.aValue > 5) { // More red = warm
            score.warm += 0.40 * (labAnalysis.aValue / 15);
            score.cool += 0.40 * (1 - labAnalysis.aValue / 15);
        }
        
        if (labAnalysis.bValue > 5) { // More yellow = warm
            score.warm += 0.40 * (labAnalysis.bValue / 20);
        } else if (labAnalysis.bValue < -5) { // More blue = cool
            score.cool += 0.40;
        }

        // User input verification (30% weight)
        if (userInputs.veinColor) {
            const veinScore = this.analyzeVeinColor(userInputs.veinColor);
            score.warm += veinScore.warm * 0.30;
            score.cool += veinScore.cool * 0.30;
            score.neutral += veinScore.neutral * 0.30;
        }

        // Normalize scores
        const total = score.warm + score.cool + score.neutral;
        score.warm = (score.warm / total) * 100;
        score.cool = (score.cool / total) * 100;
        score.neutral = (score.neutral / total) * 100;

        // Determine primary undertone
        let undertone = 'neutral';
        let confidence = 'medium';
        
        if (score.warm > 60) {
            undertone = 'warm';
            confidence = score.warm > 75 ? 'high' : 'medium';
        } else if (score.cool > 60) {
            undertone = 'cool';
            confidence = score.cool > 75 ? 'high' : 'medium';
        } else if (Math.abs(score.warm - score.cool) < 15) {
            undertone = 'neutral';
            confidence = 'high';
        }

        // Determine color season
        const colorSeason = this.determineColorSeason(undertone, labAnalysis.lValue, score);

        return {
            undertone,
            confidence,
            scores: score,
            colorSeason,
            analysis: {
                rgb: rgbAnalysis,
                lab: labAnalysis
            }
        };
    }

    /**
     * Extract skin tone pixels from image
     */
    extractSkinTones(imageData) {
        const pixels = [];
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            // Filter for skin tones using expanded criteria
            if (this.isSkinTone(r, g, b)) {
                pixels.push({ r, g, b });
            }
        }
        
        return pixels;
    }

    /**
     * Check if RGB values represent skin tone
     */
    isSkinTone(r, g, b) {
        // Expanded skin tone detection for diverse skin tones
        const max = Math.max(r, g, b);
        const min = Math.min(r, g, b);
        
        // Basic skin tone criteria
        if (r > 95 && g > 40 && b > 20 &&
            max - min > 15 &&
            Math.abs(r - g) > 15 &&
            r > g && r > b) {
            return true;
        }
        
        // Dark skin tones
        if (r > 40 && r < 95 && 
            g > 20 && g < 80 &&
            b > 15 && b < 70 &&
            r > g && g >= b) {
            return true;
        }
        
        return false;
    }

    /**
     * Analyze RGB ratios for warmth/coolness
     */
    analyzeRGBRatios(pixels) {
        if (pixels.length === 0) {
            return { warmth: 0.5, saturation: 0 };
        }

        let totalR = 0, totalG = 0, totalB = 0;
        
        pixels.forEach(pixel => {
            totalR += pixel.r;
            totalG += pixel.g;
            totalB += pixel.b;
        });
        
        const avgR = totalR / pixels.length;
        const avgG = totalG / pixels.length;
        const avgB = totalB / pixels.length;
        
        // Calculate warmth index (higher = warmer)
        const warmth = (avgR + avgG) / (avgR + avgG + 2 * avgB);
        
        // Calculate saturation
        const max = Math.max(avgR, avgG, avgB);
        const min = Math.min(avgR, avgG, avgB);
        const saturation = max > 0 ? (max - min) / max : 0;
        
        return {
            warmth,
            saturation,
            avgR,
            avgG,
            avgB
        };
    }

    /**
     * Convert RGB to LAB color space for better analysis
     */
    analyzeLabColor(pixels) {
        if (pixels.length === 0) {
            return { lValue: 50, aValue: 0, bValue: 0 };
        }

        // Average RGB
        let avgR = 0, avgG = 0, avgB = 0;
        pixels.forEach(p => {
            avgR += p.r;
            avgG += p.g;
            avgB += p.b;
        });
        avgR /= pixels.length;
        avgG /= pixels.length;
        avgB /= pixels.length;

        // Convert to LAB
        const lab = this.rgbToLab(avgR, avgG, avgB);
        
        return lab;
    }

    /**
     * RGB to LAB conversion
     */
    rgbToLab(r, g, b) {
        // Normalize RGB
        r = r / 255;
        g = g / 255;
        b = b / 255;

        // Convert to XYZ
        r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
        g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
        b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

        let x = (r * 0.4124 + g * 0.3576 + b * 0.1805) * 100;
        let y = (r * 0.2126 + g * 0.7152 + b * 0.0722) * 100;
        let z = (r * 0.0193 + g * 0.1192 + b * 0.9505) * 100;

        // Convert XYZ to LAB
        x = x / 95.047;
        y = y / 100.000;
        z = z / 108.883;

        x = x > 0.008856 ? Math.pow(x, 1/3) : (7.787 * x) + 16/116;
        y = y > 0.008856 ? Math.pow(y, 1/3) : (7.787 * y) + 16/116;
        z = z > 0.008856 ? Math.pow(z, 1/3) : (7.787 * z) + 16/116;

        const lValue = (116 * y) - 16;
        const aValue = 500 * (x - y);
        const bValue = 200 * (y - z);

        return { lValue, aValue, bValue };
    }

    /**
     * Analyze vein color (user input)
     */
    analyzeVeinColor(veinColor) {
        const scores = {
            'green': { warm: 0.9, cool: 0.05, neutral: 0.05 },
            'blue': { warm: 0.05, cool: 0.9, neutral: 0.05 },
            'blue-green': { warm: 0.4, cool: 0.4, neutral: 0.2 },
            'purple': { warm: 0.1, cool: 0.8, neutral: 0.1 },
            'unsure': { warm: 0.33, cool: 0.33, neutral: 0.34 }
        };
        
        return scores[veinColor] || scores['unsure'];
    }

    /**
     * Determine seasonal color analysis
     */
    determineColorSeason(undertone, lValue, scores) {
        // Spring: Warm + Light
        // Summer: Cool + Light
        // Autumn: Warm + Deep
        // Winter: Cool + Deep
        
        const isLight = lValue > 60;
        
        if (undertone === 'warm') {
            return isLight ? 'spring' : 'autumn';
        } else if (undertone === 'cool') {
            return isLight ? 'summer' : 'winter';
        } else {
            // Neutral can be soft summer or soft autumn
            return scores.cool > scores.warm ? 'summer' : 'autumn';
        }
    }

    /**
     * Get recommended colors based on analysis
     */
    getRecommendedColors(colorSeason, undertone) {
        const colorPalettes = {
            spring: {
                colors: ['#FFD700', '#FF6B6B', '#FFA07A', '#98D8C8', '#F7DC6F', '#85C1E2', '#FFDAB9', '#FF69B4'],
                description: 'Warm, bright colors with yellow undertones. Think coral, peach, golden yellow, and warm pink.',
                avoid: ['Black', 'Pure white', 'Navy', 'Dark purple']
            },
            summer: {
                colors: ['#B4A7D6', '#87CEEB', '#DDA0DD', '#F0E68C', '#E6E6FA', '#AFEEEE', '#C4C4E8', '#FFB6C1'],
                description: 'Cool, soft colors with blue undertones. Lavender, powder blue, soft pink, and dusty rose.',
                avoid: ['Orange', 'Warm browns', 'Golden yellows', 'Bright warm colors']
            },
            autumn: {
                colors: ['#CD853F', '#D2691E', '#8B4513', '#DAA520', '#B8860B', '#BC8F8F', '#A0522D', '#8B6508'],
                description: 'Warm, rich earthy tones. Rust, olive, camel, burgundy, and warm browns.',
                avoid: ['Bright pink', 'Cool blues', 'Icy pastels', 'Pure black']
            },
            winter: {
                colors: ['#000080', '#8B0000', '#4B0082', '#2F4F4F', '#DC143C', '#1C1C1C', '#191970', '#800020'],
                description: 'Cool, vivid colors and true neutrals. Navy, burgundy, pure black, pure white, and jewel tones.',
                avoid: ['Orange', 'Golden yellow', 'Warm browns', 'Muted earth tones']
            }
        };
        
        return colorPalettes[colorSeason] || colorPalettes.autumn;
    }
}

// Export for use in main app
if (typeof module !== 'undefined' && module.exports) {
    module.exports = UndertoneAnalyzer;
}
        
    </script>

    <!-- Include enhanced modules -->
    <script src="undertone_analyzer.js"></script>
    <script src="body_type_recommendations.js"></script>
