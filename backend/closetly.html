<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Closetly - Your Personal Style AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        /* Authentication Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 440px;
            width: 100%;
            padding: 48px 40px;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .auth-logo {
            text-align: center;
            margin-bottom: 32px;
        }

        .auth-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .auth-logo p {
            color: #666;
            font-size: 0.95rem;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .form-group input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .auth-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.05rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        .auth-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .auth-switch {
            text-align: center;
            margin-top: 24px;
            color: #666;
        }

        .auth-switch a {
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
        }

        .auth-switch a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        .success-message {
            background: #efe;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.9rem;
            display: none;
        }

        /* Main App (Hidden until logged in) */
        .main-app {
            display: none;
        }
    </style>
</head>
<body>

<!-- =======================
     LOGIN PAGE
======================= -->
<div id="loginPage" class="auth-container">
    <div class="auth-card">
        <div class="auth-logo">
            <h1>‚ú® Closetly</h1>
            <p>Your Personal Style AI</p>
        </div>

        <div id="loginError" class="error-message"></div>

        <form id="loginForm">
            <div class="form-group">
                <label for="loginEmail">Email Address</label>
                <input type="email" id="loginEmail" required placeholder="you@example.com">
            </div>

            <div class="form-group">
                <label for="loginPassword">Password</label>
                <input type="password" id="loginPassword" required placeholder="Enter your password">
            </div>

            <button type="submit" class="auth-btn" id="loginBtn">Log In</button>
        </form>

        <div class="auth-switch">
            Don't have an account? <a href="#" onclick="showSignup(); return false;">Sign Up</a>
        </div>
    </div>
</div>

<!-- =======================
     SIGNUP PAGE
======================= -->
<div id="signupPage" class="auth-container" style="display: none;">
    <div class="auth-card">
        <div class="auth-logo">
            <h1>‚ú® Closetly</h1>
            <p>Create Your Account</p>
        </div>

        <div id="signupError" class="error-message"></div>
        <div id="signupSuccess" class="success-message"></div>

        <form id="signupForm">
            <div class="form-group">
                <label for="signupName">Full Name</label>
                <input type="text" id="signupName" required placeholder="Your name">
            </div>

            <div class="form-group">
                <label for="signupEmail">Email Address</label>
                <input type="email" id="signupEmail" required placeholder="you@example.com">
            </div>

            <div class="form-group">
                <label for="signupPassword">Password</label>
                <input type="password" id="signupPassword" required minlength="6">
            </div>

            <div class="form-group">
                <label for="signupPasswordConfirm">Confirm Password</label>
                <input type="password" id="signupPasswordConfirm" required>
            </div>

            <button type="submit" class="auth-btn" id="signupBtn">Create Account</button>
        </form>

        <div class="auth-switch">
            Already have an account? <a href="#" onclick="showLogin(); return false;">Log In</a>
        </div>
    </div>
</div>

<!-- =======================
     MAIN APP (AUTH-GATED)
======================= -->
<div id="mainApp" class="main-app" style="display:none;">
    <div class="container">
        <div class="header">
            <h1>Closetly</h1>
            <p class="tagline">Personalised Fashion At Your FingerTips</p>
            <p class="subtitle">AI-powered style recommendations for everyone</p>
        </div>

        <div class="step-indicator">
            <div class="step-dot active" id="dot1"></div>
            <div class="step-dot" id="dot2"></div>
            <div class="step-dot" id="dot3"></div>
            <div class="step-dot" id="dot4"></div>
        </div>

        <div class="progress-bar">
            <div class="progress" id="progressBar" style="width: 25%"></div>
        </div>

        <!-- Step 0: Gender Selection -->
        <div class="step active" id="step0">
            <div class="quiz-section">
                <h2>Tell Us About Yourself</h2>
                <p>Choose your style preference to get personalized recommendations:</p>

                <div class="gender-selection">
                    <div class="gender-option" data-gender="women">
                        <span class="gender-icon">üë©</span>
                        <div><strong>Women's Style</strong></div>
                        <small>Dresses, blazers, and contemporary fashion</small>
                    </div>
                    <div class="gender-option" data-gender="men">
                        <span class="gender-icon">üë®</span>
                        <div><strong>Men's Style</strong></div>
                        <small>Suits, casual wear, and modern essentials</small>
                    </div>
                    <div class="gender-option" data-gender="unisex">
                        <span class="gender-icon">‚ú®</span>
                        <div><strong>Non-Binary / Fluid</strong></div>
                        <small>All styles, no limits</small>
                    </div>
                </div>

                <div style="text-align: center;">
                    <button class="btn" id="genderNextBtn" disabled>Next: Body Assessment</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =======================
     GLOBAL STATE & INIT
======================= -->
<script>
let currentUser = null;
let sessionToken = null;

let userProfile = {
    gender: null,
    body_type: null,
    dominant_colors: [],
    colorSeason: null
};

let appInitialized = false;

function initApp() {
    if (appInitialized) return;
    appInitialized = true;
    console.log('Closetly app initialized');
}

function showMainApp() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('signupPage').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    initApp();
}
</script>


<!-- Step 1: Body Type Quiz -->
<div class="step" id="step1">
    <div class="quiz-section">
        <h2>Step 1: Body Type Assessment</h2>
        <p>Choose your preferred method for the most accurate recommendations:</p>
        
        <div class="assessment-method">
            <div class="method-toggle">
                <button class="method-btn active" onclick="switchMethod('visual')" id="visualBtn">Visual Assessment</button>
                <button class="method-btn" onclick="switchMethod('measurements')" id="measurementsBtn">Enter Measurements</button>
            </div>
        </div>

        <!-- Visual Assessment -->
        <div id="visualAssessment" class="assessment-content">
            <div class="question">
                <h3>1. How would you describe your shoulder width compared to your hips?</h3>
                <div class="options">
                    <div class="option" data-question="q1" data-value="wider">Shoulders wider than hips</div>
                    <div class="option" data-question="q1" data-value="equal">Shoulders equal to hips</div>
                    <div class="option" data-question="q1" data-value="narrower">Shoulders narrower than hips</div>
                </div>
            </div>

            <div class="question">
                <h3>2. Where do you tend to gain weight first?</h3>
                <div class="options">
                    <div class="option" data-question="q2" data-value="upper">Upper body (arms, chest, shoulders)</div>
                    <div class="option" data-question="q2" data-value="middle">Middle section (waist, stomach)</div>
                    <div class="option" data-question="q2" data-value="lower">Lower body (hips, thighs, legs)</div>
                    <div class="option" data-question="q2" data-value="overall">Evenly throughout</div>
                </div>
            </div>

            <div class="question">
                <h3>3. How would you describe your torso shape?</h3>
                <div class="options">
                    <div class="option" data-question="q3" data-value="defined">Well-defined waist, curvy silhouette</div>
                    <div class="option" data-question="q3" data-value="straight">Straight, athletic build</div>
                    <div class="option" data-question="q3" data-value="fuller">Fuller midsection, rounded silhouette</div>
                </div>
            </div>

            <div class="question">
                <h3>4. What's your chest/bust measurement compared to your hips?</h3>
                <div class="options">
                    <div class="option" data-question="q4" data-value="larger">Chest/bust larger than hips</div>
                    <div class="option" data-question="q4" data-value="same">About the same size</div>
                    <div class="option" data-question="q4" data-value="smaller">Chest/bust smaller than hips</div>
                </div>
            </div>
        </div>

        <!-- Measurements Assessment -->
        <div id="measurementsAssessment" class="assessment-content" style="display: none;">
            <p style="color: #666; margin-bottom: 20px; text-align: center;">
                Enter your measurements for the most accurate body type analysis
            </p>
            <div class="measurements-form">
                <div class="measurement-input">
                    <label>Shoulder Width (inches)</label>
                    <input type="number" id="shoulderInput" step="0.5" min="10" max="30">
                </div>
                <div class="measurement-input">
                    <label id="chestLabel">Bust (inches)</label>
                    <input type="number" id="chestInput" step="0.5" min="20" max="60">
                </div>
                <div class="measurement-input">
                    <label>Waist (inches)</label>
                    <input type="number" id="waistInput" step="0.5" min="20" max="60">
                </div>
                <div class="measurement-input">
                    <label>Hip (inches)</label>
                    <input type="number" id="hipInput" step="0.5" min="20" max="60">
                </div>
                <div class="measurement-input">
                    <label>Height (inches)</label>
                    <input type="number" id="heightInput" step="0.5" min="48" max="84">
                </div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="previousStep()">‚Üê Back</button>
            <button class="btn" onclick="calculateBodyType()" id="nextBtn1" disabled>Next: Color Analysis</button>
        </div>
    </div>
</div>

<!-- Step 2: Color Analysis -->
<div class="step" id="step2">
    <div class="quiz-section">
        <h2>Step 2: Personal Color Analysis</h2>
        <p>Upload a clear photo of your face in natural lighting for personalized color analysis:</p>

        <div class="upload-area" id="uploadArea">
            <div id="uploadContent">
                <p>üì∑ Click to upload or drag and drop your photo</p>
                <p style="font-size: 0.9rem; color: #666; margin-top: 10px;">Supported formats: JPG, PNG</p>
                <small style="color: #888;">We analyze skin tone, undertones, and natural features</small>
            </div>
            <img id="imagePreview" style="display: none;">
            <input type="file" id="imageInput" accept="image/*" style="display: none;">
        </div>

        <div id="colorAnalysisLoading" class="loading" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing your personal colors...</p>
        </div>

        <div style="text-align: center; margin-top: 20px;">
            <button class="btn" onclick="previousStep()">‚Üê Back</button>
            <button class="btn" onclick="analyzeColors()" id="nextBtn2" disabled>Get My Style Profile</button>
        </div>
    </div>
</div>

<!-- Step 3: Results -->
<div class="step" id="step3">
    <div class="results">
        <h2>Your Closetly Style Profile</h2>
        <p>Based on your assessment, here are your personalized recommendations:</p>

        <div class="result-card" id="bodyTypeResult">
            <h3>Your Body Type: <span id="bodyTypeName"></span></h3>
            <p id="bodyTypeDescription"></p>
        </div>

        <div class="result-card" id="colorAnalysisResult">
            <h3>Your Personal Color Palette</h3>
            <div class="color-palette" id="colorPalette"></div>
            <p id="colorDescription"></p>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="previousStep()">‚Üê Back</button>
            <button class="btn" onclick="resetQuiz()">New Assessment</button>
        </div>
    </div>
</div>

<!-- AI Chatbot Widget -->
<div class="chat-widget">
    <button class="chat-toggle-btn" id="chatToggle" onclick="toggleChatbot()">
        <span class="chat-icon">ü§ñ</span>
        <span class="chat-notification" id="chatNotification">1</span>
    </button>

    <div class="chat-container" id="chatbotContainer">
        <div class="chat-header">
            <div class="chat-avatar">üëó</div>
            <div class="chat-header-info">
                <h3>Style Advisor</h3>
                <p>AI-powered outfit expert</p>
            </div>
        </div>

        <div class="chat-messages" id="chatbotMessages"></div>

        <div class="chat-input-container">
            <input type="text"
                   class="chat-input"
                   id="chatbotInput"
                   placeholder="Ask about your outfit..."
                   onkeypress="handleChatKeyPress(event)">
            <button class="chat-send-btn" onclick="sendChatMessage()">‚û§</button>
        </div>
    </div>
</div>

<script>
/* ================================
   STEP & QUIZ STATE
================================ */
let currentStep = 0;
let quizAnswers = {};
let assessmentMethod = 'visual';
let measurements = {};
let uploadedImage = null;
let uploadedOutfitImage = null;

/* ================================
   USER PROFILE (SINGLE SOURCE)
================================ */
let userProfile = {
    gender: null,
    body_type: null,
    dominant_colors: [],
    colorSeason: null
};

/* ================================
   CHATBOT STATE (PERSISTENT)
================================ */
let chatbotOpen = false;
let chatbotHistory = [];

function loadChatHistory() {
    if (!currentUser) return;
    chatbotHistory = JSON.parse(
        localStorage.getItem(`chat_${currentUser.id}`) || '[]'
    );
}

function saveChatHistory() {
    if (!currentUser) return;
    localStorage.setItem(
        `chat_${currentUser.id}`,
        JSON.stringify(chatbotHistory)
    );
}

/* ================================
   RETAILER URL MAPPING
================================ */
const retailerURLs = {
    'Myntra': 'https://www.myntra.com/shop/',
    'Ajio': 'https://www.ajio.com/search/?text=',
    'Flipkart': 'https://www.flipkart.com/search?q=',
    'Amazon India': 'https://www.amazon.in/s?k=',
    'Lifestyle': 'https://www.lifestylestores.com/in/en/search/?text=',
    'Westside': 'https://www.westside.com/search?q=',
    'Shoppers Stop': 'https://www.shoppersstop.com/search?q=',
    'Reliance Trends': 'https://www.reliancetrends.com/search?q=',
    'Max Fashion': 'https://www.maxfashion.in/in/en/search/?text='
};

/* ================================
   PRODUCT IMAGE PLACEHOLDERS
================================ */
const productImages = {
    'Wrap Midi Dress': 'https://images.unsplash.com/photo-1595777457583-95e059d581b8?w=400',
    'High-Waisted Jeans': 'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?w=400',
    'Fitted Blazer': 'https://images.unsplash.com/photo-1591047139829-d91aecb6caea?w=400',
    'Silk Blouse': 'https://images.unsplash.com/photo-1564584217132-2271feaeb3c5?w=400',
    'Pencil Skirt': 'https://images.unsplash.com/photo-1583496661160-fb5886a0aaaa?w=400',
    'Bodycon Dress': 'https://images.unsplash.com/photo-1566174053879-31528523f8ae?w=400',
    'Oxford Shirt': 'https://images.unsplash.com/photo-1602810318383-e386cc2a3ccf?w=400',
    'Slim Fit Chinos': 'https://images.unsplash.com/photo-1473966968600-fa801b869a1a?w=400',
    'Formal Suit': 'https://images.unsplash.com/photo-1594938298603-c8148c4dae35?w=400',
    'Polo Shirt': 'https://images.unsplash.com/photo-1586790170083-2f9ceadc732d?w=400',
    'Leather Jacket': 'https://images.unsplash.com/photo-1551028719-00167b16eac5?w=400',
    'Denim Jeans': 'https://images.unsplash.com/photo-1542272604-787c3835535d?w=400',
    'Oversized Hoodie': 'https://images.unsplash.com/photo-1556821840-3a63f95609a7?w=400',
    'Denim Jacket': 'https://images.unsplash.com/photo-1576995853123-5a10305d93c0?w=400',
    'Basic White Tee': 'https://images.unsplash.com/photo-1521572163474-6864f9cf17ab?w=400',
    'Joggers': 'https://images.unsplash.com/photo-1517438322307-e67111335449?w=400'
};

/* ================================
   BODY TYPE RECOMMENDATIONS
================================ */
const bodyTypeRecommendations = {
    women: {
        Hourglass: {
            description: 'You have a balanced, proportionate silhouette with a defined waist.',
            recommendations: [
                'Wrap dresses that cinch at the waist',
                'High-waisted jeans and trousers',
                'Fitted blazers and structured jackets',
                'Bodycon dresses and pencil skirts',
                'Belted coats and dresses',
                'V-neck and scoop neck tops'
            ]
        },
        Pear: {
            description: 'You have narrower shoulders and bust with fuller hips and thighs.',
            recommendations: [
                'Boat neck and off-shoulder tops',
                'Statement sleeves and embellished tops',
                'Dark-colored bootcut and flared jeans',
                'A-line skirts and dresses',
                'Structured blazers with shoulder details',
                'Bright colored scarves and statement necklaces'
            ]
        },
        Apple: {
            description: 'You carry weight in your midsection with broader shoulders.',
            recommendations: [
                'Empire waist dresses and tops',
                'V-neck and deep scoop neck styles',
                'Open cardigans and longline jackets',
                'Straight-leg and bootcut jeans',
                'Flowy tunics and A-line tops',
                'Mid-rise trousers with structured tops'
            ]
        },
        Rectangle: {
            description: 'You have a straight, athletic build with minimal waist definition.',
            recommendations: [
                'Peplum tops and ruffled blouses',
                'Belted dresses and high-waisted bottoms',
                'Layered outfits with jackets',
                'Textured fabrics and bold prints',
                'Cropped jackets and structured blazers',
                'Fit-and-flare dresses'
            ]
        },
        'Inverted Triangle': {
            description: 'You have broader shoulders and bust with narrower hips.',
            recommendations: [
                'A-line and flared skirts',
                'Wide-leg trousers and bootcut jeans',
                'V-neck and scoop neck tops',
                'Unstructured, flowy tops',
                'Bright colored bottoms with dark tops',
                'Wrap dresses with fuller skirts'
            ]
        }
    },

    men: {
        Athletic: {
            description: 'You have broad shoulders, a narrow waist, and a muscular build.',
            recommendations: [
                'Fitted dress shirts and polo shirts',
                'Slim-fit blazers and sport coats',
                'Tapered trousers and slim-fit jeans',
                'V-neck sweaters and henley shirts',
                'Structured suits with defined shoulders',
                'Form-fitting casual tees'
            ]
        },
        Rectangle: {
            description: 'You have a straight build with similar measurements.',
            recommendations: [
                'Layered looks with jackets and vests',
                'Textured fabrics and patterns',
                'Double-breasted blazers',
                'Chunky knit sweaters',
                'Horizontal striped shirts',
                'Slim-fit pants to create shape'
            ]
        },
        'Inverted Triangle': {
            description: 'You have broad shoulders and chest with a narrower waist.',
            recommendations: [
                'Straight-leg and relaxed-fit jeans',
                'Unstructured blazers without padding',
                'Crew neck sweaters and t-shirts',
                'Simple, clean-line shirts',
                'Solid colors and minimal patterns',
                'Casual, unpadded jackets'
            ]
        },
        Trapezoid: {
            description: 'You have narrower shoulders with broader hips and thighs.',
            recommendations: [
                'Structured blazers with shoulder pads',
                'Fitted shirts with broader collars',
                'Vertical striped patterns',
                'Tailored jackets with defined shoulders',
                'V-neck sweaters',
                'Straight-cut formal trousers'
            ]
        },
        Oval: {
            description: 'You carry weight in your midsection with a fuller torso.',
            recommendations: [
                'V-neck shirts and sweaters',
                'Open blazers and cardigans',
                'Vertical stripe patterns',
                'Longer length shirts',
                'Straight-leg trousers',
                'Dark colors for upper body'
            ]
        }
    },

    unisex: {
        Balanced: {
            description: 'You have a well-proportioned silhouette.',
            recommendations: [
                'Oversized blazers and structured jackets',
                'High-waisted bottoms with tucked shirts',
                'Tailored pants and jeans',
                'Gender-neutral cuts',
                'Layered looks',
                'Statement accessories'
            ]
        },
        Linear: {
            description: 'You have a straight, elongated silhouette.',
            recommendations: [
                'Structured pieces with geometric lines',
                'Tailored fits throughout',
                'Monochromatic color schemes',
                'Minimal jewelry',
                'Sharp silhouettes',
                'Contemporary minimalist pieces'
            ]
        }
    }
};
</script>


<script>
/* ================================
   SAMPLE PRODUCTS
================================ */
const sampleProducts = {
    women: [
        { name: 'Wrap Midi Dress', brand: 'AND', price: 1999, originalPrice: 2999, rating: 4.5, category: 'dresses' },
        { name: 'High-Waisted Jeans', brand: 'Levi\'s', price: 2499, originalPrice: 3499, rating: 4.6, category: 'jeans' },
        { name: 'Fitted Blazer', brand: 'Marks & Spencer', price: 2999, originalPrice: 4499, rating: 4.7, category: 'blazers' },
        { name: 'Silk Blouse', brand: 'Van Heusen Woman', price: 1499, originalPrice: 2199, rating: 4.4, category: 'tops' },
        { name: 'Pencil Skirt', brand: 'Vero Moda', price: 1299, originalPrice: 1899, rating: 4.3, category: 'skirts' },
        { name: 'Bodycon Dress', brand: 'Forever New', price: 2799, originalPrice: 3999, rating: 4.6, category: 'dresses' }
    ],
    men: [
        { name: 'Oxford Shirt', brand: 'Van Heusen', price: 1299, originalPrice: 1799, rating: 4.6, category: 'shirts' },
        { name: 'Slim Fit Chinos', brand: 'Allen Solly', price: 1599, originalPrice: 2299, rating: 4.5, category: 'pants' },
        { name: 'Formal Suit', brand: 'Raymond', price: 9999, originalPrice: 14999, rating: 4.8, category: 'suits' },
        { name: 'Polo Shirt', brand: 'US Polo Assn', price: 899, originalPrice: 1299, rating: 4.7, category: 'shirts' },
        { name: 'Leather Jacket', brand: 'Being Human', price: 4999, originalPrice: 6999, rating: 4.6, category: 'jackets' },
        { name: 'Denim Jeans', brand: 'Levi\'s 511', price: 2299, originalPrice: 3199, rating: 4.7, category: 'jeans' }
    ],
    unisex: [
        { name: 'Oversized Hoodie', brand: 'Nike', price: 1999, originalPrice: 2799, rating: 4.4, category: 'hoodies' },
        { name: 'Denim Jacket', brand: 'Levi\'s', price: 2999, originalPrice: 3999, rating: 4.6, category: 'jackets' },
        { name: 'Basic White Tee', brand: 'H&M', price: 499, originalPrice: 799, rating: 4.5, category: 'tshirts' },
        { name: 'Joggers', brand: 'Adidas', price: 1499, originalPrice: 2199, rating: 4.3, category: 'bottoms' }
    ]
};

/* ================================
   PRICE COMPARISON DATA
================================ */
const priceComparisonData = {
    Blazer: [
        { retailer: 'Myntra', brand: 'Marks & Spencer', price: 2999, originalPrice: 4499, rating: 4.5, image: productImages['Fitted Blazer'] },
        { retailer: 'Ajio', brand: 'Van Heusen', price: 2699, originalPrice: 3999, rating: 4.3, image: productImages['Fitted Blazer'] },
        { retailer: 'Flipkart', brand: 'Peter England', price: 2499, originalPrice: 3499, rating: 4.6, image: productImages['Fitted Blazer'] },
        { retailer: 'Amazon India', brand: 'Allen Solly', price: 2799, originalPrice: 3799, rating: 4.4, image: productImages['Fitted Blazer'] }
    ],
    'Formal Shirt': [
        { retailer: 'Myntra', brand: 'Van Heusen', price: 1299, originalPrice: 1799, rating: 4.6, image: productImages['Oxford Shirt'] },
        { retailer: 'Lifestyle', brand: 'Louis Philippe', price: 1599, originalPrice: 2299, rating: 4.5, image: productImages['Oxford Shirt'] },
        { retailer: 'Amazon India', brand: 'Arrow', price: 1199, originalPrice: 1699, rating: 4.3, image: productImages['Oxford Shirt'] },
        { retailer: 'Flipkart', brand: 'Peter England', price: 999, originalPrice: 1499, rating: 4.4, image: productImages['Oxford Shirt'] }
    ],
    Jeans: [
        { retailer: 'Myntra', brand: 'Levi\'s 511', price: 2299, originalPrice: 3199, rating: 4.7, image: productImages['Denim Jeans'] },
        { retailer: 'Ajio', brand: 'Flying Machine', price: 1599, originalPrice: 2299, rating: 4.4, image: productImages['Denim Jeans'] },
        { retailer: 'Amazon India', brand: 'Wrangler', price: 1799, originalPrice: 2499, rating: 4.3, image: productImages['Denim Jeans'] },
        { retailer: 'Lifestyle', brand: 'Lee', price: 2099, originalPrice: 2899, rating: 4.2, image: productImages['Denim Jeans'] }
    ],
    Dress: [
        { retailer: 'Myntra', brand: 'AND', price: 1999, originalPrice: 2999, rating: 4.5, image: productImages['Wrap Midi Dress'] },
        { retailer: 'Ajio', brand: 'Vero Moda', price: 1799, originalPrice: 2599, rating: 4.4, image: productImages['Bodycon Dress'] },
        { retailer: 'Lifestyle', brand: 'Forever New', price: 2499, originalPrice: 3499, rating: 4.6, image: productImages['Wrap Midi Dress'] },
        { retailer: 'Amazon India', brand: 'Athena', price: 1399, originalPrice: 1999, rating: 4.3, image: productImages['Bodycon Dress'] }
    ]
};

/* ================================
   OUTFIT KNOWLEDGE BASE
================================ */
const outfitKnowledge = {
    bodyTypeAdvice: {
        Hourglass: 'Your balanced silhouette looks stunning in fitted styles! Try wrap dresses, high-waisted jeans, and belted blazers.',
        Pear: 'Balance your figure with statement tops and darker bottoms. Boat necks and A-line skirts are perfect!',
        Apple: 'Empire waist dresses and V-necks elongate your torso beautifully. Flow is your friend!',
        Rectangle: 'Add curves with peplum tops, belts, and textured fabrics. Layering works wonders!',
        'Inverted Triangle': 'Balance broad shoulders with A-line bottoms and wide-leg pants. Soft fabrics are key!',
        Athletic: 'Your proportions work with most styles! Try fitted cuts and structured pieces.',
        Trapezoid: 'Create shoulder emphasis with structured blazers and vertical stripes.',
        Oval: 'V-necks and vertical patterns elongate beautifully. Dark tops with bright bottoms create balance!',
        Balanced: 'You can wear almost anything! Experiment with different styles.',
        Linear: 'Structured pieces and tailored fits complement your silhouette perfectly.'
    },
    colorAdvice: {
        spring: 'Warm, bright colors like coral, peach, and golden yellow make you glow! ‚ú®',
        summer: 'Cool, soft pastels like lavender, powder blue, and soft pink suit you best! üíú',
        autumn: 'Rich earth tones like rust, olive, and camel enhance your warmth! üçÇ',
        winter: 'Bold jewel tones, pure white, and black create stunning contrast! ‚ùÑÔ∏è'
    }
};

/* ================================
   UTILITIES
================================ */
function getRetailerSearchURL(retailer, brand, productName) {
    const searchQuery = encodeURIComponent(`${brand} ${productName}`);
    const baseURL = retailerURLs[retailer] || 'https://www.google.com/search?q=';
    return baseURL + searchQuery;
}

/* ================================
   INIT (AUTH-SAFE)
================================ */
function initGenderSelection() {
    document.querySelectorAll('.gender-option').forEach(option => {
        option.addEventListener('click', function () {
            document.querySelectorAll('.gender-option')
                .forEach(opt => opt.classList.remove('selected'));

            this.classList.add('selected');
            userProfile.gender = this.dataset.gender;

            document.getElementById('genderNextBtn').disabled = false;
        });
    });
}

/* Hook into app lifecycle */
if (typeof initApp === 'function') {
    const originalInitApp = initApp;
    initApp = function () {
        originalInitApp();
        initGenderSelection();
    };
}
</script>


<script>
/* ================================
   OPTION SELECTION (VISUAL QUIZ)
================================ */
function initVisualQuiz() {
    document.querySelectorAll('.option').forEach(option => {
        option.addEventListener('click', function () {
            const question = this.dataset.question;
            const value = this.dataset.value;

            document
                .querySelectorAll(`[data-question="${question}"]`)
                .forEach(opt => opt.classList.remove('selected'));

            this.classList.add('selected');
            quizAnswers[question] = value;

            checkQuizComplete();
        });
    });
}

/* ================================
   IMAGE UPLOAD
================================ */
function initImageUpload() {
    const uploadArea = document.getElementById('uploadArea');
    const imageInput = document.getElementById('imageInput');

    if (!uploadArea || !imageInput) return;

    uploadArea.addEventListener('click', () => imageInput.click());

    imageInput.addEventListener('change', e => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });
}

/* ================================
   ASSESSMENT METHOD
================================ */
function switchMethod(method) {
    assessmentMethod = method;

    document.getElementById('visualBtn')
        .classList.toggle('active', method === 'visual');
    document.getElementById('measurementsBtn')
        .classList.toggle('active', method === 'measurements');

    document.getElementById('visualAssessment').style.display =
        method === 'visual' ? 'block' : 'none';

    document.getElementById('measurementsAssessment').style.display =
        method === 'measurements' ? 'block' : 'none';

    if (method === 'measurements') {
        const chestLabel = document.getElementById('chestLabel');
        if (chestLabel) {
            chestLabel.textContent =
                userProfile.gender === 'women'
                    ? 'Bust (inches)'
                    : 'Chest (inches)';
        }
        setupMeasurementListeners();
    }

    checkQuizComplete();
}

/* ================================
   MEASUREMENT INPUTS
================================ */
function setupMeasurementListeners() {
    ['shoulderInput', 'chestInput', 'waistInput', 'hipInput', 'heightInput']
        .forEach(id => {
            const input = document.getElementById(id);
            if (!input) return;

            input.addEventListener('input', () => {
                measurements[id.replace('Input', '')] =
                    parseFloat(input.value) || 0;

                checkQuizComplete();
            });
        });
}

/* ================================
   QUIZ COMPLETION CHECK
================================ */
function checkQuizComplete() {
    const nextBtn1 = document.getElementById('nextBtn1');
    if (!nextBtn1) return;

    if (assessmentMethod === 'visual') {
        const complete = ['q1', 'q2', 'q3', 'q4']
            .every(q => quizAnswers[q]);
        nextBtn1.disabled = !complete;
    } else {
        const complete = ['shoulder', 'chest', 'waist', 'hip', 'height']
            .every(k => measurements[k] && measurements[k] > 0);
        nextBtn1.disabled = !complete;
    }
}

/* ================================
   BODY TYPE CALCULATION
================================ */
function calculateBodyType() {
    userProfile.body_type =
        assessmentMethod === 'measurements'
            ? calculateBodyTypeFromMeasurements()
            : calculateBodyTypeFromQuiz();

    nextStep();
}

function calculateBodyTypeFromMeasurements() {
    const { shoulder, chest, waist, hip } = measurements;

    if (userProfile.gender === 'women') {
        const bustHipRatio = chest / hip;
        const waistBustRatio = waist / chest;

        if (bustHipRatio >= 0.95 && bustHipRatio <= 1.05 && waistBustRatio <= 0.75)
            return 'Hourglass';
        if (bustHipRatio < 0.95) return 'Pear';
        if (waistBustRatio >= 0.75) return 'Apple';
        if (bustHipRatio > 1.05) return 'Inverted Triangle';
        return 'Rectangle';
    }

    if (userProfile.gender === 'men') {
        const shoulderWaistRatio = shoulder / waist;
        const chestWaistRatio = chest / waist;

        if (shoulderWaistRatio >= 1.40 && chestWaistRatio >= 1.25)
            return 'Athletic';
        if (shoulderWaistRatio >= 1.30) return 'Inverted Triangle';
        if (shoulder < hip) return 'Trapezoid';
        if (chestWaistRatio <= 1.15) return 'Oval';
        return 'Rectangle';
    }

    return waist / chest < 0.80 ? 'Balanced' : 'Linear';
}

function calculateBodyTypeFromQuiz() {
    const { q1, q2, q3, q4 } = quizAnswers;

    if (userProfile.gender === 'men') {
        if (q1 === 'wider' && q3 === 'defined') return 'Athletic';
        if (q1 === 'wider' && q4 === 'larger') return 'Inverted Triangle';
        if (q1 === 'narrower' && q4 === 'smaller') return 'Trapezoid';
        if (q3 === 'fuller' && q2 === 'middle') return 'Oval';
        return 'Rectangle';
    }

    if (userProfile.gender === 'women') {
        if (q1 === 'equal' && q3 === 'defined') return 'Hourglass';
        if (q1 === 'narrower' && q4 === 'smaller') return 'Pear';
        if (q1 === 'wider' && q4 === 'larger') return 'Inverted Triangle';
        if (q3 === 'fuller' && q2 === 'middle') return 'Apple';
        return 'Rectangle';
    }

    return q3 === 'straight' ? 'Linear' : 'Balanced';
}

/* ================================
   HOOK INTO APP INIT
================================ */
if (typeof initApp === 'function') {
    const originalInitApp = initApp;
    initApp = function () {
        originalInitApp();
        initVisualQuiz();
        initImageUpload();
    };
}
</script>


<script>
/* ================================
   IMAGE UPLOAD
================================ */
function handleFileUpload(file) {
    if (!file.type.startsWith('image/')) return;

    const reader = new FileReader();
    reader.onload = e => {
        uploadedImage = e.target.result;

        const preview = document.getElementById('imagePreview');
        preview.src = uploadedImage;
        preview.style.display = 'block';

        document.getElementById('uploadContent').style.display = 'none';
        document.getElementById('nextBtn2').disabled = false;
    };
    reader.readAsDataURL(file);
}

/* ================================
   COLOR ANALYSIS (SIMULATED)
================================ */
function analyzeColors() {
    if (!uploadedImage) return;

    document.getElementById('colorAnalysisLoading').style.display = 'block';
    document.getElementById('nextBtn2').disabled = true;

    setTimeout(() => {
        const palettes = {
            spring: {
                colors: ['#FFD700', '#FF6B6B', '#FFA07A', '#98D8C8', '#F7DC6F', '#85C1E2'],
                description: 'Warm, bright colors with yellow undertones.'
            },
            summer: {
                colors: ['#B4A7D6', '#87CEEB', '#DDA0DD', '#F0E68C', '#E6E6FA', '#AFEEEE'],
                description: 'Cool, soft colors with blue undertones.'
            },
            autumn: {
                colors: ['#CD853F', '#D2691E', '#8B4513', '#DAA520', '#B8860B', '#BC8F8F'],
                description: 'Warm, rich colors with golden undertones.'
            },
            winter: {
                colors: ['#000080', '#8B0000', '#4B0082', '#2F4F4F', '#DC143C', '#1C1C1C'],
                description: 'Cool, vivid colors with blue undertones.'
            }
        };

        const seasons = Object.keys(palettes);
        const season = seasons[Math.floor(Math.random() * seasons.length)];
        const palette = palettes[season];

        userProfile.dominant_colors = palette.colors;
        userProfile.colorSeason = season;
        userProfile.colorDescription = palette.description;

        document.getElementById('colorAnalysisLoading').style.display = 'none';
        nextStep();
    }, 2000);
}

/* ================================
   STEP NAVIGATION
================================ */
function nextStep() {
    if (currentStep >= 3) return;

    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.getElementById(`dot${currentStep + 1}`).classList.add('completed');
    document.getElementById(`dot${currentStep + 1}`).classList.remove('active');

    currentStep++;

    document.getElementById(`step${currentStep}`).classList.add('active');

    if (currentStep < 3) {
        document.getElementById(`dot${currentStep + 1}`).classList.add('active');
    }

    document.getElementById('progressBar').style.width =
        ((currentStep + 1) / 4) * 100 + '%';

    if (currentStep === 3) {
        generateResults();
        generatePriceComparison();
    }
}

function previousStep() {
    if (currentStep <= 0) return;

    document.getElementById(`step${currentStep}`).classList.remove('active');
    document.getElementById(`dot${currentStep + 1}`).classList.remove('active');

    currentStep--;

    document.getElementById(`step${currentStep}`).classList.add('active');
    document.getElementById(`dot${currentStep + 1}`).classList.add('active');

    document.getElementById('progressBar').style.width =
        ((currentStep + 1) / 4) * 100 + '%';
}

/* ================================
   RESULTS GENERATION
================================ */
function generateResults() {
    const gender = userProfile.gender;
    const bodyType = userProfile.body_type;

    const info =
        bodyTypeRecommendations[gender]?.[bodyType] ||
        bodyTypeRecommendations.unisex[bodyType];

    document.getElementById('bodyTypeName').textContent = bodyType;
    document.getElementById('bodyTypeDescription').textContent = info.description;

    const palette = document.getElementById('colorPalette');
    palette.innerHTML = '';

    userProfile.dominant_colors.forEach(color => {
        const swatch = document.createElement('div');
        swatch.className = 'color-swatch';
        swatch.style.backgroundColor = color;
        palette.appendChild(swatch);
    });

    document.getElementById('colorDescription').textContent =
        userProfile.colorDescription ||
        'These colors complement your natural features!';

    generateStyleRecommendations();
    generateProductRecommendations();
}

/* ================================
   STYLE RECOMMENDATIONS
================================ */
function generateStyleRecommendations() {
    const container = document.getElementById('styleRecommendations');
    container.innerHTML = '';

    const gender = userProfile.gender;
    const bodyType = userProfile.body_type;

    const info =
        bodyTypeRecommendations[gender]?.[bodyType] ||
        bodyTypeRecommendations.unisex[bodyType];

    info.recommendations.forEach(text => {
        const card = document.createElement('div');
        card.className = 'recommendation-card';
        card.innerHTML = `
            <h4>${text}</h4>
            <p>Perfect for your ${bodyType.toLowerCase()} body type.</p>
            <span class="tag">${gender === 'men' ? "Men's" : gender === 'women' ? "Women's" : 'Unisex'} Style</span>
        `;
        container.appendChild(card);
    });
}

/* ================================
   PRODUCT RECOMMENDATIONS
================================ */
function generateProductRecommendations() {
    const grid = document.getElementById('productGrid');
    grid.innerHTML = '';

    const gender = userProfile.gender;
    const products = sampleProducts[gender] || sampleProducts.unisex;

    products.forEach(product => {
        const discount = Math.round(
            ((product.originalPrice - product.price) / product.originalPrice) * 100
        );

        const image = productImages[product.name] || '';
        const url = getRetailerSearchURL('Myntra', product.brand, product.name);

        const card = document.createElement('div');
        card.className = 'product-card';
        card.onclick = () => window.open(url, '_blank');

        card.innerHTML = `
            ${discount > 0 ? `<div class="product-badge">-${discount}%</div>` : ''}
            <div class="product-image">
                ${image ? `<img src="${image}">` : 'üëï'}
            </div>
            <div class="product-info">
                <div class="product-brand">${product.brand}</div>
                <div class="product-name">${product.name}</div>
                <div class="product-price">
                    ‚Çπ${product.price}
                    ${product.originalPrice > product.price ? `<span class="price-compare">‚Çπ${product.originalPrice}</span>` : ''}
                </div>
                <button class="shop-btn">Shop Now</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

/* ================================
   PRICE COMPARISON
================================ */
function generatePriceComparison() {
    const container = document.getElementById('comparisonResults');
    if (!container) return;

    container.innerHTML = '';

    Object.entries(priceComparisonData).forEach(([type, items]) => {
        const section = document.createElement('div');
        section.innerHTML = `<h4>${type}</h4>`;

        [...items]
            .sort((a, b) => a.price - b.price)
            .forEach((item, index) => {
                const best = index === 0;
                const url = getRetailerSearchURL(item.retailer, item.brand, type);

                const row = document.createElement('a');
                row.href = url;
                row.target = '_blank';
                row.className = `comparison-item ${best ? 'best-deal' : ''}`;
                row.innerHTML = `
                    <strong>${item.brand}</strong> ‚Äî ‚Çπ${item.price}
                    ${best ? '<span>‚ú® Best Deal</span>' : ''}
                `;
                section.appendChild(row);
            });

        container.appendChild(section);
    });
}
</script>

       <script>
/* ================================
   TABS & FILTERS
================================ */
function filterComparisons() {
    generatePriceComparison();
}

function showTab(tabName, tabElement) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    tabElement.classList.add('active');
}

/* ================================
   RESET QUIZ
================================ */
function resetQuiz() {
    currentStep = 0;
    quizAnswers = {};
    uploadedImage = null;
    assessmentMethod = 'visual';
    measurements = {};

    userProfile = {
        gender: null,
        body_type: null,
        dominant_colors: [],
        colorSeason: null,
        colorDescription: null
    };

    document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
    document.getElementById('step0').classList.add('active');

    document.querySelectorAll('.step-dot').forEach((dot, i) => {
        dot.classList.remove('active', 'completed');
        if (i === 0) dot.classList.add('active');
    });

    document.getElementById('progressBar').style.width = '25%';
    document.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));

    document.getElementById('genderNextBtn').disabled = true;
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('uploadContent').style.display = 'block';
}

/* ================================
   CHATBOT
================================ */
function toggleChatbot() {
    chatbotOpen = !chatbotOpen;

    const container = document.getElementById('chatbotContainer');
    const btn = document.getElementById('chatToggle');
    const notification = document.getElementById('chatNotification');

    if (chatbotOpen) {
        container.classList.add('open');
        btn.classList.add('active');
        notification.style.display = 'none';

        if (chatbotHistory.length === 0) initializeChatbot();
    } else {
        container.classList.remove('open');
        btn.classList.remove('active');
    }
}

function initializeChatbot() {
    addChatMessage(
        'bot',
        `Hi! I'm your AI Style Advisor üëã<br><br>
        I can help with:<br>
        ‚ú® Body type styling<br>
        üé® Color guidance<br>
        üëó Outfit analysis<br>
        üé≠ Occasion dressing<br><br>
        How can I help you?`,
        ['Color advice', 'Body type tips', 'Occasion help']
    );
}

function sendChatMessage() {
    const input = document.getElementById('chatbotInput');
    const message = input.value.trim();
    if (!message) return;

    addChatMessage('user', message);
    input.value = '';

    showChatTyping();
    setTimeout(() => {
        hideChatTyping();
        const res = generateChatResponse(message);
        addChatMessage('bot', res.text, res.quickReplies, res.options || {});
    }, 1200);
}

/* ================================
   CHATBOT RESPONSE LOGIC
================================ */
function generateChatResponse(message) {
    const msg = message.toLowerCase();
    const gender = userProfile.gender;
    const bodyType = userProfile.body_type;
    const colors = userProfile.dominant_colors;

    if (msg.includes('color')) {
        if (!userProfile.colorSeason) {
            return {
                text: 'Upload your photo in the color analysis step to get personalized color advice üé®',
                quickReplies: ['Start color analysis']
            };
        }

        return {
            text: `üé® **Your Color Season:** ${userProfile.colorSeason.toUpperCase()}<br><br>
            ${outfitKnowledge.colorAdvice[userProfile.colorSeason]}`,
            quickReplies: ['Body type tips', 'Outfit advice']
        };
    }

    if (msg.includes('body')) {
        if (!bodyType) {
            return {
                text: 'Complete the body type quiz to get styling tips üëó',
                quickReplies: ['Start assessment']
            };
        }

        return {
            text: `üëó **${bodyType} Body Type**<br><br>
            ${outfitKnowledge.bodyTypeAdvice[bodyType]}`,
            quickReplies: ['Color advice', 'Outfit ideas']
        };
    }

    if (msg.includes('outfit') || msg.includes('look')) {
        if (!bodyType) {
            return {
                text: 'Finish the quiz so I can analyze outfits for your body type!',
                quickReplies: ['Start quiz']
            };
        }

        const score = Math.floor(Math.random() * 15) + 80;
        return {
            text: `‚ú® **Outfit Analysis**<br><br>
            Suitability Score: <strong>${score}/100</strong><br><br>
            This look works well for your ${bodyType} body type.`,
            quickReplies: ['Color advice', 'Occasion help']
        };
    }

    if (msg.includes('office') || msg.includes('party') || msg.includes('wedding')) {
        return {
            text: `üé≠ **Occasion Styling Tip**<br><br>
            Dress according to comfort + confidence. Structured fits for office, expressive styles for parties, and elegant traditional or fusion wear for weddings.`,
            quickReplies: ['Body type tips', 'Color advice']
        };
    }

    return {
        text: `I can help with:<br><br>
        üëó Body type styling<br>
        üé® Color matching<br>
        üëî Outfit analysis<br>
        üé≠ Occasion looks`,
        quickReplies: ['Body type tips', 'Color advice', 'Occasion help']
    };
}

/* ================================
   CHAT UI HELPERS
================================ */
function addChatMessage(type, text, quickReplies = [], options = {}) {
    const container = document.getElementById('chatbotMessages');

    const msg = document.createElement('div');
    msg.className = `chat-message ${type}-message`;

    const bubble = document.createElement('div');
    bubble.className = 'message-bubble';
    bubble.innerHTML = text;
    msg.appendChild(bubble);

    if (quickReplies.length) {
        const replies = document.createElement('div');
        replies.className = 'quick-replies';

        quickReplies.forEach(r => {
            const btn = document.createElement('button');
            btn.className = 'quick-reply-btn';
            btn.textContent = r;
            btn.onclick = () => sendQuickReply(r);
            replies.appendChild(btn);
        });

        msg.appendChild(replies);
    }

    container.appendChild(msg);
    container.scrollTop = container.scrollHeight;
    chatbotHistory.push({ type, text });
}

function sendQuickReply(text) {
    document.getElementById('chatbotInput').value = text;
    sendChatMessage();
}

function showChatTyping() {
    const container = document.getElementById('chatbotMessages');
    const t = document.createElement('div');
    t.id = 'typingIndicator';
    t.className = 'typing-indicator';
    t.innerHTML = '<span></span><span></span><span></span>';
    container.appendChild(t);
    container.scrollTop = container.scrollHeight;
}

function hideChatTyping() {
    const t = document.getElementById('typingIndicator');
    if (t) t.remove();
}

function handleChatKeyPress(e) {
    if (e.key === 'Enter') sendChatMessage();
}
</script>

    
   <!-- ================================
   PRICE API PLACEHOLDERS
================================ -->
<script>
async function fetchPricesFromAPI(brand, category) {
    try {
        const response = await fetch('/api/predict', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                brand,
                category,
                material: 'Cotton',
                retailer: 'Myntra',
                season: 'All-Season',
                rating: 4.0,
                discount_percent: 0
            })
        });
        return await response.json();
    } catch (err) {
        console.error('Price API error:', err);
        return null;
    }
}

async function compareAcrossRetailers(brand, category, productName) {
    try {
        const response = await fetch('/api/compare', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ brand, category, product_name: productName })
        });
        return await response.json();
    } catch (err) {
        console.error('Compare API error:', err);
        return null;
    }
}

console.log('Closetly loaded ‚úì');
</script>

<!-- ================================
   AUTHENTICATION & PROFILE
================================ -->
<script>
const AUTH_API = window.location.origin;

/* Session restore */
window.addEventListener('load', () => {
    const token = localStorage.getItem('sessionToken');
    if (token) verifySession(token);
});

/* UI helpers */
function showLogin() {
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('signupPage').style.display = 'none';
}

function showSignup() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('signupPage').style.display = 'flex';
}

/* ================================
   LOGIN
================================ */
document.getElementById('loginForm').addEventListener('submit', async e => {
    e.preventDefault();

    const email = loginEmail.value;
    const password = loginPassword.value;
    const btn = loginBtn;
    const errorDiv = loginError;

    btn.disabled = true;
    btn.textContent = 'Logging in...';
    errorDiv.style.display = 'none';

    try {
        const res = await fetch(`${AUTH_API}/api/auth/login`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!data.success) throw new Error(data.error);

        sessionToken = data.session_token;
        currentUser = data.user;
        localStorage.setItem('sessionToken', sessionToken);

        await loadUserProfile();
        showMainApp();
    } catch (err) {
        errorDiv.textContent = err.message || 'Login failed';
        errorDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Log In';
    }
});

/* ================================
   SIGNUP
================================ */
document.getElementById('signupForm').addEventListener('submit', async e => {
    e.preventDefault();

    const btn = signupBtn;
    const errorDiv = signupError;
    const successDiv = signupSuccess;

    if (signupPassword.value !== signupPasswordConfirm.value) {
        errorDiv.textContent = 'Passwords do not match';
        errorDiv.style.display = 'block';
        return;
    }

    btn.disabled = true;
    btn.textContent = 'Creating account...';

    try {
        const res = await fetch(`${AUTH_API}/api/auth/signup`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                full_name: signupName.value,
                email: signupEmail.value,
                password: signupPassword.value
            })
        });

        const data = await res.json();
        if (!data.success) throw new Error(data.error);

        sessionToken = data.session_token;
        currentUser = data.user;
        localStorage.setItem('sessionToken', sessionToken);

        successDiv.textContent = 'Account created!';
        successDiv.style.display = 'block';

        setTimeout(showMainApp, 1000);
    } catch (err) {
        errorDiv.textContent = err.message || 'Signup failed';
        errorDiv.style.display = 'block';
    } finally {
        btn.disabled = false;
        btn.textContent = 'Create Account';
    }
});

/* ================================
   SESSION VERIFY
================================ */
async function verifySession(token) {
    try {
        const res = await fetch(`${AUTH_API}/api/profile/verify`, {
            headers: { Authorization: `Bearer ${token}` }
        });
        const data = await res.json();

        if (!data.authenticated) throw new Error();

        sessionToken = token;
        currentUser = data.user;
        await loadUserProfile();
        showMainApp();
    } catch {
        localStorage.removeItem('sessionToken');
    }
}

/* ================================
   PROFILE LOAD / SAVE
================================ */
async function loadUserProfile() {
    try {
        const res = await fetch(`${AUTH_API}/api/profile/get`, {
            headers: { Authorization: `Bearer ${sessionToken}` }
        });
        const data = await res.json();

        if (data.success && data.profile) {
            userProfile = {
                ...userProfile,
                ...data.profile
            };

            if (userProfile.body_type && userProfile.dominant_colors?.length) {
                currentStep = 3;
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('step3').classList.add('active');
                generateResults();
            }
        }
    } catch (err) {
        console.error('Profile load failed:', err);
    }
}

async function saveUserProfile() {
    if (!sessionToken) return;
    try {
        await fetch(`${AUTH_API}/api/profile/save`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${sessionToken}`
            },
            body: JSON.stringify(userProfile)
        });
    } catch (err) {
        console.error('Profile save failed:', err);
    }
}

/* ================================
   LOGOUT
================================ */
async function logout() {
    try {
        if (sessionToken) {
            await fetch(`${AUTH_API}/api/auth/logout`, {
                method: 'POST',
                headers: { Authorization: `Bearer ${sessionToken}` }
            });
        }
    } catch {}

    localStorage.removeItem('sessionToken');
    sessionToken = null;
    currentUser = null;

    document.getElementById('mainApp').style.display = 'none';
    showLogin();
}
</script>

   <script>
/* ================================
   ENHANCED BODY TYPE RECOMMENDATIONS
================================ */

const bodyTypeRecommendations = {
    women: {
        Hourglass: {
            description: 'You have a balanced, proportionate silhouette with a well-defined waist.',
            recommendations: [
                'Wrap dresses that cinch the waist',
                'High-waisted jeans and trousers',
                'Fitted blazers and belted jackets',
                'Bodycon or sheath dresses',
                'V-neck and scoop neck tops'
            ],
            stylingTips: [
                'Always define the waist',
                'Choose fitted over boxy silhouettes',
                'Balance top and bottom proportions'
            ],
            celebrityInspiration: ['Priyanka Chopra', 'Sofia Vergara']
        },

        Pear: {
            description: 'Narrower shoulders with fuller hips and thighs.',
            recommendations: [
                'Boat neck and off-shoulder tops',
                'Statement sleeves and embellished tops',
                'Dark bootcut or flared jeans',
                'A-line skirts and dresses',
                'Structured blazers'
            ],
            stylingTips: [
                'Draw attention upward',
                'Keep bottoms darker and structured',
                'Add volume to shoulders'
            ],
            celebrityInspiration: ['Beyonc√©', 'Jennifer Lopez']
        },

        Apple: {
            description: 'Fuller midsection with broader shoulders and slimmer legs.',
            recommendations: [
                'Empire waist dresses',
                'V-neck and wrap tops',
                'Straight-leg jeans',
                'Longline jackets',
                'Flowy tunics'
            ],
            stylingTips: [
                'Create vertical lines',
                'Avoid clingy fabrics at waist',
                'Highlight legs'
            ]
        },

        Rectangle: {
            description: 'Straight build with minimal waist definition.',
            recommendations: [
                'Peplum tops',
                'Fit-and-flare dresses',
                'Belts at waist',
                'Layered outfits',
                'Textured fabrics'
            ],
            stylingTips: [
                'Add curves visually',
                'Use belts and layers',
                'Play with structure'
            ]
        },

        'Inverted Triangle': {
            description: 'Broader shoulders with narrower hips.',
            recommendations: [
                'A-line skirts',
                'Wide-leg trousers',
                'V-neck tops',
                'Unstructured blazers',
                'Flowy fabrics'
            ],
            stylingTips: [
                'Soften shoulders',
                'Add volume to lower body'
            ]
        }
    },

    men: {
        Athletic: {
            description: 'Broad shoulders with a narrow waist.',
            recommendations: [
                'Slim-fit shirts',
                'Tailored blazers',
                'Tapered trousers',
                'Crew and V-neck tees'
            ]
        },
        Rectangle: {
            description: 'Straight build with similar proportions.',
            recommendations: [
                'Layered looks',
                'Textured fabrics',
                'Structured jackets'
            ]
        }
    },

    unisex: {
        Balanced: {
            description: 'Well-proportioned silhouette.',
            recommendations: [
                'Tailored fits',
                'Oversized blazers',
                'Monochrome looks'
            ]
        }
    }
};
</script>
